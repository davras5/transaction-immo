<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verkaufsplattform - Bundesamt für Bauten und Logistik</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet" />
  <style>
    /* --- Design Tokens (Modern Unified Color Scheme) --- */
    :root {
      /* Primary Palette - Brand Colors */
      --primary-900: #383E54;
      --primary-700: #2D3748;
      --primary-500: #4A5568;
      --primary-100: #EDF2F7;

      /* Accent Palette - Unified Teal */
      --accent-600: #0077B6;
      --accent-500: #0096C7;
      --accent-100: #CAF0F8;

      /* Neutral Palette - Simplified Grays */
      --neutral-900: #1A202C;
      --neutral-700: #4A5568;
      --neutral-500: #718096;
      --neutral-300: #CBD5E0;
      --neutral-200: #E2E8F0;
      --neutral-100: #F7FAFC;
      --neutral-50: #FFFFFF;

      /* Priority Colors - Semantic */
      --priority-high-bg: #FEE2E2;
      --priority-high-text: #B91C1C;
      --priority-high-marker: #DC2626;

      --priority-normal-bg: #D1FAE5;
      --priority-normal-text: #047857;
      --priority-normal-marker: #10B981;

      --priority-low-bg: #DBEAFE;
      --priority-low-text: #1D4ED8;
      --priority-low-marker: #3B82F6;

      --priority-none-bg: #F3F4F6;
      --priority-none-text: #6B7280;
      --priority-none-marker: #9CA3AF;

      --priority-null-bg: #F9FAFB;
      --priority-null-text: #9CA3AF;
      --priority-null-border: #E5E7EB;
      --priority-null-marker: #D1D5DB;

      /* Interactive States */
      --state-hover-bg: #F7FAFC;
      --state-active-bg: var(--accent-600);
      --state-focus-ring: 0 0 0 3px rgba(0, 119, 182, 0.2);
      --state-disabled: #CBD5E0;

      /* Shadows */
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.12);
      --shadow-xl: 0 8px 32px rgba(0, 0, 0, 0.15);

      /* Overlays */
      --overlay-bg: rgba(0, 0, 0, 0.5);
    }

    /* --- Reset & Base --- */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { height: 100%; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background-color: var(--neutral-100); color: var(--neutral-900); line-height: 1.5;
      display: flex; flex-direction: column; min-height: 100%;
    }

    /* --- Header --- */
    .header {
      background-color: var(--primary-900); color: var(--neutral-50); padding: 0 24px;
      display: flex; align-items: center; justify-content: space-between;
      height: 64px; flex-shrink: 0;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .logo {
      width: 32px; height: 32px; background: var(--neutral-50); color: var(--primary-900);
      border-radius: 4px; display: flex; align-items: center; justify-content: center;
      font-size: 18px; font-weight: bold;
    }
    .header-title { display: flex; flex-direction: column; }
    .header-title-main { font-size: 14px; font-weight: 600; }
    .header-title-sub { font-size: 12px; opacity: 0.9; }
    .header-right { display: flex; gap: 16px; }
    .btn {
      padding: 8px 16px; border-radius: 4px; font-size: 14px; cursor: pointer; border: none;
      transition: background-color 0.2s;
    }
    .btn-primary { background-color: var(--accent-600); color: var(--neutral-50); }
    .btn-primary:hover { background-color: var(--accent-500); }
    .btn-outline { background-color: transparent; color: var(--neutral-50); border: 1px solid var(--neutral-50); }
    .btn-outline:hover { background-color: rgba(255,255,255,0.1); }

    /* --- Search & Filter --- */
    .search-section { background: var(--neutral-50); padding: 16px 0; flex-shrink: 0; border-bottom: 1px solid var(--neutral-200); }
    .search-section-inner { max-width: 1440px; margin: 0 auto; padding: 0 24px; }
    .search-row { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
    .search-input-wrapper { flex: 1; position: relative; }
    .search-input-wrapper .material-icons-outlined {
      position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
      color: var(--neutral-500); font-size: 20px;
    }
    .search-input {
      width: 100%; padding: 12px 16px 12px 44px;
      border: 1px solid var(--neutral-200); border-radius: 6px; font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .search-input:focus { outline: none; border-color: var(--accent-600); box-shadow: var(--state-focus-ring); }
    .view-toggle { display: flex; background: var(--neutral-100); border-radius: 6px; padding: 4px; }
    .view-toggle .material-icons-outlined { font-size: 20px; }
    .view-btn {
      padding: 8px 12px; border: none; background: transparent; cursor: pointer;
      border-radius: 4px; color: var(--neutral-500); display: flex; align-items: center; justify-content: center;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
    }
    .view-btn:hover { color: var(--neutral-900); }
    .view-btn.active { background: var(--accent-600); color: var(--neutral-50); box-shadow: var(--shadow-sm); }
    .view-btn-label { font-size: 13px; font-weight: 500; margin-left: 6px; }

    /* --- Filter Row & Priority Pills --- */
    .filter-row { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
    .filter-pills { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; flex: 1; }
    .filter-pill {
      padding: 8px 16px; border: 1px solid var(--neutral-200); border-radius: 20px;
      font-size: 13px; background: var(--neutral-50); color: var(--neutral-700); cursor: pointer;
      transition: all 0.2s; white-space: nowrap; display: inline-flex; align-items: center; gap: 6px;
    }
    .filter-pill:hover { border-color: var(--neutral-300); background: var(--neutral-100); }
    .filter-pill.active { background: var(--accent-600); border-color: var(--accent-600); color: var(--neutral-50); }
    .filter-pill .close-icon { display: none; font-size: 16px; margin-left: 2px; margin-right: -4px; }
    .filter-pill.active .close-icon { display: inline; }
    .reset-filters {
      display: none; align-items: center; justify-content: center; padding: 6px;
      border: none; background: transparent; color: var(--neutral-500); cursor: pointer;
      border-radius: 4px; transition: all 0.2s;
    }
    .reset-filters.visible { display: flex; }
    .reset-filters:hover { background: var(--neutral-100); color: var(--neutral-900); }
    .filter-right { display: flex; align-items: center; gap: 16px; }
    .stats-count { font-size: 14px; color: var(--neutral-700); font-weight: 600; }
    .filter-btn {
      display: flex; align-items: center; gap: 6px; padding: 8px 16px;
      border: 1px solid var(--neutral-200); border-radius: 20px; background: var(--neutral-50);
      font-size: 13px; color: var(--neutral-700); cursor: pointer; transition: all 0.2s;
    }
    .filter-btn .material-icons-outlined { font-size: 20px; }
    .filter-btn:hover { border-color: var(--accent-600); color: var(--accent-600); }
    .filter-btn.has-filters { border-color: var(--accent-600); color: var(--accent-600); background: var(--accent-100); }
    .filter-btn.panel-open { border-color: var(--accent-600); color: var(--neutral-50); background: var(--accent-600); }
    .filter-btn .filter-count {
      background: var(--accent-600); color: var(--neutral-50); font-size: 11px; font-weight: 600;
      padding: 2px 6px; border-radius: 10px; margin-left: 2px;
    }

    /* --- Filter Modal --- */
    .filter-modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: var(--overlay-bg); display: flex; align-items: flex-start; justify-content: center;
      padding: 80px 20px 40px; z-index: 1000; overflow-y: auto;
      opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
    }
    .filter-modal-overlay.active { opacity: 1; visibility: visible; }
    .filter-modal {
      background: var(--neutral-50); border-radius: 12px; width: 100%; max-width: 900px;
      box-shadow: var(--shadow-xl);
      transform: translateY(-20px); transition: transform 0.3s;
    }
    .filter-modal-overlay.active .filter-modal { transform: translateY(0); }
    .filter-modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 20px 24px; border-bottom: 1px solid var(--neutral-200);
    }
    .filter-modal-header h2 { font-size: 18px; font-weight: 600; color: var(--neutral-900); margin: 0; }
    .filter-modal-actions { display: flex; align-items: center; gap: 8px; }
    .filter-reset-btn, .filter-close-btn {
      width: 36px; height: 36px; border: none; background: var(--neutral-100);
      border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; color: var(--neutral-500);
    }
    .filter-reset-btn:hover, .filter-close-btn:hover { background: var(--neutral-200); color: var(--neutral-900); }
    .filter-modal-body { padding: 24px; }
    .filter-columns { display: grid; grid-template-columns: repeat(5, 1fr); gap: 24px; }
    .filter-column-title { font-size: 14px; font-weight: 600; color: var(--neutral-900); margin-bottom: 16px; }
    .filter-options { display: flex; flex-direction: column; gap: 8px; }
    .filter-option {
      padding: 10px 14px; border-radius: 6px; font-size: 13px;
      background: var(--neutral-100); color: var(--neutral-700); cursor: pointer; transition: all 0.2s;
      border: 1px solid transparent; display: flex; align-items: center; justify-content: space-between;
    }
    .filter-option:hover { background: var(--state-hover-bg); border-color: var(--neutral-200); }
    .filter-option.selected { background: var(--accent-600); color: var(--neutral-50); border-color: var(--accent-600); }
    .filter-option .close-icon { display: none; font-size: 16px; opacity: 0.7; }
    .filter-option.selected .close-icon { display: inline; }
    .filter-option.selected:hover .close-icon { opacity: 1; }

    @media (max-width: 900px) {
      .filter-columns { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 640px) {
      .filter-columns { grid-template-columns: repeat(2, 1fr); }
      .filter-modal { margin: 10px; max-width: calc(100% - 20px); }
    }

    /* --- Main Layout --- */
    .main {
      max-width: 1440px; margin: 0 auto; padding: 24px;
      flex: 1; display: flex; flex-direction: column; min-height: 0; width: 100%;
    }

    /* --- Gallery Grid --- */
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; }
    @media (max-width: 1200px) { .grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 900px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }

    /* --- Card Style --- */
    .card {
      background: var(--neutral-50); border-radius: 8px; overflow: hidden;
      box-shadow: var(--shadow-md); cursor: pointer;
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); }
    .card-image { position: relative; height: 180px; background-color: var(--neutral-200); background-size: cover; background-position: center; }
    /* Tag Style Shared */
    .priority-tag { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 500; box-shadow: var(--shadow-sm); }
    .priority-0 { background-color: var(--priority-high-bg); color: var(--priority-high-text); }
    .priority-1 { background-color: var(--priority-normal-bg); color: var(--priority-normal-text); }
    .priority-2 { background-color: var(--priority-low-bg); color: var(--priority-low-text); }
    .priority-3 { background-color: var(--priority-none-bg); color: var(--priority-none-text); }
    .priority-null { background-color: var(--priority-null-bg); color: var(--priority-null-text); border: 1px solid var(--priority-null-border); }

    /* Image Tags Container */
    .image-tags { position: absolute; top: 12px; left: 12px; display: flex; gap: 10px; z-index: 2; }
    .year-tag { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 500; background-color: var(--priority-none-bg); color: var(--priority-none-text); box-shadow: var(--shadow-sm); }

    /* Clickable tag styles */
    .priority-tag[data-filter], .year-tag[data-filter] { cursor: pointer; transition: transform 0.15s, filter 0.15s; }
    .priority-tag[data-filter]:hover, .year-tag[data-filter]:hover { transform: scale(1.05); filter: brightness(0.95); }

    .card-badge { position: absolute; top: 12px; left: 12px; }
    .card-content { padding: 16px; }
    .card-label { font-size: 15px; font-weight: 600; color: var(--neutral-900); margin-bottom: 4px; }
    .card-location { font-size: 13px; color: var(--neutral-700); margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--neutral-200); }
    .card-price { font-size: 15px; font-weight: 600; color: var(--neutral-900); margin-bottom: 2px; }
    .card-price-sqm { font-size: 12px; color: var(--neutral-500); margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--neutral-200); }
    .card-details { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 8px; font-size: 13px; margin-bottom: 16px; }
    .card-detail-label { color: var(--neutral-700); font-weight: 500; }
    .card-detail-value { color: var(--neutral-900); font-weight: 500; }
    .card-milestone { padding-top: 0px; }
    .milestone-bar { height: 6px; background: var(--neutral-200); border-radius: 3px; overflow: hidden; margin-bottom: 8px; }
    .milestone-progress { height: 100%; background: linear-gradient(90deg, var(--accent-600), var(--accent-500)); border-radius: 3px; transition: width 0.3s; }
    .milestone-text { font-size: 13px; color: var(--neutral-700); font-weight: 500; }

    /* --- List View --- */
    .view-container { display: none; }
    .view-container.active { display: block; }
    .stats-boxes { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px; }
    .stats-box { background: var(--neutral-50); border-radius: 8px; padding: 20px; text-align: center; box-shadow: var(--shadow-md); }
    .stats-box-value { font-size: 32px; font-weight: 600; color: var(--neutral-900); margin-bottom: 4px; }
    .stats-box-label { font-size: 13px; color: var(--neutral-500); }
    .stats-box-download { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s; }
    .stats-box-download:hover { background-color: var(--neutral-100); }
    .stats-box-download .material-icons-outlined { font-size: 32px; color: var(--neutral-500); margin-bottom: 4px; }
    .list-table-container { background: var(--neutral-50); border-radius: 8px; overflow: hidden; box-shadow: var(--shadow-md); }
    .list-table { width: 100%; border-collapse: collapse; }
    .list-table th { background: var(--neutral-100); padding: 14px 16px; text-align: left; font-size: 13px; font-weight: 600; color: var(--neutral-700); border-bottom: 1px solid var(--neutral-200); }
    .list-table td { padding: 14px 16px; font-size: 14px; color: var(--neutral-900); border-bottom: 1px solid var(--neutral-200); vertical-align: middle; }
    .list-table tbody tr:hover { background-color: var(--neutral-100); cursor: pointer; }
    .object-cell { display: flex; align-items: center; gap: 12px; }
    .object-icon { color: var(--neutral-500); font-size: 20px; }
    .milestone-text-small { font-size: 12px; color: var(--neutral-500); }

    /* --- MAP VIEW & SIDEBAR FIXES --- */
    .map-container {
        display: none; width: 100%;
        flex: 1; min-height: 0;
        background: var(--neutral-50); border-radius: 8px; overflow: hidden;
        box-shadow: var(--shadow-md);
    }
    .map-container.active { display: grid; grid-template-columns: 320px 1fr; grid-template-rows: 1fr; max-height: 1200px; }

    .map-sidebar {
        width: 100%; height: 100%;
        background: var(--neutral-50); overflow-y: auto;
        border-right: 1px solid var(--neutral-200);
        scrollbar-width: thin;
    }

    /* Sidebar Item Fixes */
    .map-sidebar-item {
        padding: 16px;
        border-bottom: 1px solid var(--neutral-200);
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        flex-direction: column; /* Stack: Image top, Text bottom */
        gap: 12px;
    }
    .map-sidebar-item:hover { background-color: var(--neutral-100); }
    .map-sidebar-item.active { background-color: var(--accent-100); padding-left: 12px; border-left: 3px solid var(--accent-600); } /* Highlight style */

    .map-sidebar-image {
        position: relative;
        width: 100%;
        height: 160px; /* Fixed Height für Bild */
        background-color: var(--neutral-200);
        background-size: cover;
        background-position: center;
        border-radius: 6px;
        overflow: hidden;
    }
    /* Tags im Bild oben links */
    .map-sidebar-image .image-tags {
        top: 10px;
        left: 10px;
    }

    .map-sidebar-content { display: flex; flex-direction: column; gap: 4px; }
    .map-sidebar-title { font-size: 15px; font-weight: 600; color: var(--neutral-900); line-height: 1.3; }
    .map-sidebar-price { font-size: 14px; font-weight: 600; color: var(--accent-600); margin-top: 4px; }

    .map-area { position: relative; width: 100%; height: 100%; background-color: var(--neutral-200); overflow: hidden; }
    #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; }

    /* Map Markers */
    .marker {
        width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3); border: 2px solid var(--neutral-50);
    }
    .marker-0 { background-color: var(--priority-high-marker); }
    .marker-1 { background-color: var(--priority-normal-marker); }
    .marker-2 { background-color: var(--priority-low-marker); }
    .marker-3 { background-color: var(--priority-none-marker); }
    .marker-null { background-color: var(--priority-null-marker); }
    .marker .material-icons-outlined { color: var(--neutral-50); font-size: 16px; }
    .marker.selected { border: 3px solid var(--accent-600); transform: scale(1.15); z-index: 10; }

    .mapboxgl-popup-content { padding: 0; border-radius: 8px; overflow: hidden; min-width: 250px; }
    .popup-image { height: 120px; background-size: cover; background-position: center; }
    .popup-content { padding: 12px; }
    .popup-title { font-weight: 600; margin-bottom: 4px; }
    .popup-link { display: block; text-align: center; padding: 8px 12px; background: var(--primary-900); color: var(--neutral-50); text-decoration: none; border-radius: 4px; margin-top: 8px; cursor: pointer; }

    /* Responsive */
    @media (max-width: 900px) { .stats-boxes { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 768px) {
        .map-container.active { display: flex; flex-direction: column; height: auto; }
        .map-sidebar { width: 100%; max-height: 250px; border-right: none; border-bottom: 1px solid var(--neutral-200); }
        .map-area { height: 400px; width: 100%; }
        .map-sidebar-image { height: 120px; } /* Kleineres Bild auf Mobile */
    }
    @media (max-width: 640px) {
        .header { padding: 12px 16px; height: auto; flex-wrap: wrap; gap: 12px; }
        .search-row, .filter-row { flex-direction: column; align-items: stretch; }
        .grid { grid-template-columns: 1fr; }
    }

    /* --- Footer --- */
    .footer {
      background-color: var(--primary-900);
      color: var(--neutral-50);
      padding: 4px 24px;
      display: flex;
      align-items: center;
      justify-content: left;
      gap: 32px;
      flex-shrink: 0;
    }
    .footer-link {
      color: var(--neutral-50);
      text-decoration: none;
      font-size: 14px;
      transition: opacity 0.2s;
    }
    .footer-link:hover {
      opacity: 0.8;
    }

    /* --- Detail Page --- */
    .detail-view {
      display: none;
      flex-direction: column;
      flex: 1;
    }
    .detail-view.active {
      display: flex;
    }
    .detail-header {
      background: var(--neutral-50);
      border-bottom: 1px solid var(--neutral-200);
      padding: 16px 24px;
    }
    .detail-header-inner {
      max-width: 1440px;
      width: calc(100% - 48px);
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .detail-header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .detail-back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--neutral-100);
      border: 1px solid var(--neutral-200);
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      color: var(--neutral-700);
      transition: all 0.2s;
    }
    .detail-back-btn .material-icons-outlined {
      font-size: 18px;
    }
    .detail-back-btn:hover {
      background: var(--neutral-200);
      color: var(--neutral-900);
    }
    .detail-breadcrumb {
      font-size: 14px;
      color: var(--neutral-500);
    }

    .detail-content {
      max-width: 1440px;
      margin: 24px auto;
      padding: 24px;
      width: calc(100% - 48px);
      background: var(--neutral-50);
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
    }

    /* Hero Section with Gallery */
    .detail-hero {
      display: flex;
      flex-direction: column;
      gap: 24px;
      margin-bottom: 30px;
    }
    .detail-gallery {
      display: grid;
      grid-template-columns: 1.5fr 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 12px;
      height: 420px;
      width: 100%;
    }
    .detail-main-image {
      grid-row: 1 / 3;
      grid-column: 1;
      border-radius: 8px;
      background-size: cover;
      background-position: center;
      position: relative;
      border: none;
      outline: none;
      box-shadow: none;
    }
    .detail-main-image .image-tags {
      top: 16px;
      left: 16px;
    }
    .detail-thumb {
      border-radius: 8px;
      background-size: cover;
      background-position: center;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .detail-thumb-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 119, 182, 0.85);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--neutral-50);
      font-size: 13px;
      text-align: center;
      padding: 12px;
      cursor: pointer;
      z-index: 2;
    }
    .detail-thumb-overlay:hover {
      background: rgba(0, 119, 182, 0.95);
    }

    /* Info Row - 3 columns: Title | Price | Status */
    .detail-info {
      display: grid;
      grid-template-columns: 1.3fr 1.1fr 1fr;
      gap: 32px;
      padding: 24px 0;
    }
    .detail-info-section {
      padding: 0;
    }

    /* Title Section */
    .detail-title-section h1 {
      font-size: 22px;
      font-weight: 600;
      color: var(--neutral-900);
      margin-bottom: 4px;
    }
    .detail-areas {
      display: flex;
      gap: 28px;
      margin-top: 16px;
    }
    .detail-area {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .detail-area-icon {
      display: none;
    }
    .detail-area-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--neutral-900);
    }
    .detail-area-label {
      color: var(--neutral-500);
      font-size: 13px;
    }
    .detail-pdf-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: var(--accent-600);
      color: var(--neutral-50);
      border: 1px solid var(--accent-600);
      border-radius: 6px;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      transition: all 0.2s;
    }
    .detail-pdf-btn:hover {
      background: var(--accent-500);
      border-color: var(--accent-500);
    }

    .detail-price-cards {
      display: flex;
      gap: 24px;
      margin-top: 16px;
    }
    .detail-price-card {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .detail-price-card-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--neutral-900);
    }
    .detail-price-card-label {
      font-size: 13px;
      color: var(--neutral-500);
    }

    /* Tabs */
    .detail-tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--neutral-200);
      margin-bottom: 24px;
      margin-top: 8px;
    }
    .detail-tab {
      padding: 16px 24px;
      font-size: 14px;
      font-weight: 500;
      color: var(--neutral-500);
      background: none;
      border: none;
      cursor: pointer;
      position: relative;
      transition: color 0.2s;
    }
    .detail-tab:hover:not(.disabled) {
      color: var(--neutral-700);
    }
    .detail-tab.active {
      color: var(--accent-600);
    }
    .detail-tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent-600);
    }
    .detail-tab.disabled {
      color: var(--neutral-300);
      cursor: not-allowed;
    }

    /* Tab Content */
    .detail-tab-content {
      padding: 0;
    }
    .detail-data-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 48px;
    }
    .detail-data-column {
      display: flex;
      flex-direction: column;
    }
    .detail-data-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px 32px;
    }
    .detail-data-item {
      padding-bottom: 12px;
    }
    .detail-data-value {
      font-size: 16px;
      color: var(--neutral-900);
      font-weight: 600;
      line-height: 2;
    }
    .detail-data-label {
      font-size: 14px;
      color: var(--neutral-500);
    }

    /* Switzerland Map */
    .detail-map-container {
      background: var(--neutral-50);
      border-radius: 8px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-self: start;
      width: 100%;
    }
    .detail-map-svg {
      width: 100%;
    }
    .detail-map-svg svg {
      width: 100%;
      height: auto;
    }
    /* Cantons (layer6) - outline only, dark stroke */
    .detail-map-svg svg #layer6 path {
      fill: var(--accent-100) !important;
      stroke: var(--primary-900) !important;
      stroke-width: 1.5px !important;
    }
    .detail-map-svg svg #layer6 path.highlighted {
      fill: var(--accent-600) !important;
    }
    /* Rivers (layer4) - hidden */
    .detail-map-svg svg #layer4 {
      display: none !important;
    }
    /* Lakes (layer3) - hidden */
    .detail-map-svg svg #layer3 {
      display: none !important;
    }
    /* Border (layer2) - dark outline */
    .detail-map-svg svg #layer2 path {
      fill: transparent !important;
      stroke: var(--primary-900) !important;
      stroke-width: 2px !important;
    }

    /* External Links */
    .detail-links {
      margin-top: 32px;
    }
    .detail-links-title {
      font-size: 12px;
      color: var(--neutral-500);
      margin-bottom: 12px;
    }
    .detail-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--accent-600);
      text-decoration: none;
      font-size: 14px;
      margin-right: 24px;
      margin-bottom: 8px;
    }
    .detail-link:hover {
      text-decoration: underline;
    }
    .detail-link .material-icons-outlined {
      font-size: 16px;
    }

    /* Section Separator */
    .detail-section-separator {
      border-top: 1px solid var(--neutral-200);
      margin: 40px 0;
    }

    /* Angaben zum Objekt Section */
    .detail-object-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 48px;
    }
    .detail-object-left {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px 48px;
      align-content: start;
    }
    .detail-object-right {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .detail-geo-map {
      width: 100%;
      min-height: 400px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--neutral-200);
    }
    .detail-geo-map iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    .detail-geo-info {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
    }
    .detail-geo-coords {
      color: var(--neutral-700);
    }
    .detail-geo-address {
      color: var(--neutral-500);
    }
    .detail-route-link {
      color: var(--accent-600);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
    }
    .detail-route-link:hover {
      text-decoration: underline;
    }

    /* Marktwert & Lage Container */
    .detail-value-location {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 48px;
    }

    /* Marktwert Section */
    .detail-value-section h2 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 24px;
      color: var(--neutral-900);
    }
    .detail-value-chart {
      padding: 20px 0;
    }
    .detail-value-main {
      font-size: 24px;
      font-weight: 700;
      color: var(--neutral-900);
      text-align: center;
      margin-bottom: 24px;
    }
    .detail-value-bar-container {
      position: relative;
      margin: 0 auto;
      max-width: 400px;
    }
    .detail-value-labels {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .detail-value-labels span {
      font-size: 14px;
      color: var(--neutral-500);
    }
    .detail-value-bar {
      height: 16px;
      background: linear-gradient(to right, #E3F2FD 0%, #1976D2 50%, #0D47A1 100%);
      border-radius: 8px;
      position: relative;
    }
    .detail-value-marker {
      position: absolute;
      top: -4px;
      width: 4px;
      height: 24px;
      background: var(--neutral-900);
      transform: translateX(-50%);
    }
    .detail-value-scale {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
    }
    .detail-value-scale span {
      font-size: 12px;
      color: var(--neutral-500);
    }

    /* Lage Section */
    .detail-location-section h2 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 24px;
      color: var(--neutral-900);
    }
    .detail-location-grid {
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 500px;
    }
    .detail-location-item {
      display: grid;
      grid-template-columns: 180px 40px 1fr;
      align-items: center;
      gap: 12px;
    }
    .detail-location-label {
      font-size: 14px;
      color: var(--neutral-700);
    }
    .detail-location-value {
      font-size: 14px;
      color: var(--neutral-500);
      text-align: center;
    }
    .detail-location-bar-wrapper {
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .detail-location-bar {
      height: 8px;
      background: var(--neutral-200);
      border-radius: 4px;
      overflow: hidden;
      flex: 1;
    }
    .detail-location-bar-fill {
      height: 100%;
      background: var(--accent-600);
      border-radius: 4px;
    }
    .detail-location-stars {
      display: flex;
      gap: 4px;
    }
    .detail-location-star {
      color: var(--neutral-300);
      font-size: 18px;
    }
    .detail-location-star.filled {
      color: #FFC107;
    }

    @media (max-width: 1200px) {
      .detail-object-section,
      .detail-value-location {
        grid-template-columns: 1fr;
      }
      .detail-object-right {
        max-width: 500px;
      }
    }
    @media (max-width: 768px) {
      .detail-object-left {
        grid-template-columns: 1fr;
      }
      .detail-location-item {
        grid-template-columns: 1fr;
        gap: 4px;
      }
      .detail-location-value {
        text-align: left;
      }
    }

    /* Hide list/search when detail view is active */
    body.detail-active .search-section,
    body.detail-active .main {
      display: none;
    }

    @media (max-width: 1200px) {
      .detail-data-section {
        grid-template-columns: 1fr;
      }
      .detail-map-container {
        max-width: 500px;
      }
    }
    @media (max-width: 1100px) {
      .detail-info {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      .detail-info-section:not(:last-child) {
        border-right: none;
        border-bottom: 1px solid var(--neutral-200);
        padding-right: 0;
        padding-bottom: 16px;
      }
    }
    @media (max-width: 900px) {
      .detail-gallery {
        grid-template-columns: 1fr 1fr;
        height: 300px;
      }
      .detail-main-image {
        grid-column: 1 / 3;
        grid-row: auto;
      }
    }
    @media (max-width: 640px) {
      .detail-gallery {
        grid-template-columns: 1fr;
        height: auto;
      }
      .detail-main-image {
        grid-column: auto;
        min-height: 200px;
      }
      .detail-thumb {
        min-height: 100px;
      }
      .detail-data-grid {
        grid-template-columns: 1fr;
      }
    }

    /* --- Image Carousel --- */
    .carousel-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .carousel-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .carousel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      color: var(--neutral-50);
    }
    .carousel-counter {
      font-size: 14px;
      font-weight: 500;
    }
    .carousel-close-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--neutral-50);
      transition: background 0.2s;
    }
    .carousel-close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .carousel-main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      min-height: 0;
      padding: 0 80px;
    }
    .carousel-image-container {
      max-width: 100%;
      max-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .carousel-image {
      max-width: 100%;
      max-height: calc(100vh - 200px);
      object-fit: contain;
      border-radius: 4px;
    }
    .carousel-nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 48px;
      height: 48px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--neutral-50);
      transition: background 0.2s;
      z-index: 10;
    }
    .carousel-nav-btn:hover {
      background: rgba(255, 255, 255, 0.25);
    }
    .carousel-nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    .carousel-nav-btn.prev {
      left: 16px;
    }
    .carousel-nav-btn.next {
      right: 16px;
    }
    .carousel-thumbnails {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 16px 24px 24px;
      overflow-x: auto;
    }
    .carousel-thumb {
      width: 64px;
      height: 48px;
      border-radius: 4px;
      background-size: cover;
      background-position: center;
      cursor: pointer;
      opacity: 0.5;
      transition: opacity 0.2s, box-shadow 0.2s;
      flex-shrink: 0;
      border: 2px solid transparent;
    }
    .carousel-thumb:hover {
      opacity: 0.8;
    }
    .carousel-thumb.active {
      opacity: 1;
      border-color: var(--accent-500);
      box-shadow: 0 0 0 2px rgba(0, 150, 199, 0.3);
    }

    /* Clickable gallery images - zoom effect via pseudo-element */
    .detail-main-image.clickable,
    .detail-thumb.clickable {
      cursor: pointer;
      overflow: hidden;
    }
    .detail-main-image.clickable::before,
    .detail-thumb.clickable::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: inherit;
      border-radius: inherit;
      z-index: 1;
      transition: transform 0.3s ease;
    }
    .detail-main-image.clickable:hover::before,
    .detail-thumb.clickable:hover::before {
      transform: scale(1.05);
    }

    /* Carousel responsive */
    @media (max-width: 768px) {
      .carousel-main {
        padding: 0 16px;
      }
      .carousel-nav-btn {
        width: 40px;
        height: 40px;
      }
      .carousel-nav-btn.prev {
        left: 8px;
      }
      .carousel-nav-btn.next {
        right: 8px;
      }
      .carousel-thumb {
        width: 48px;
        height: 36px;
      }
    }

    /* --- Tab Content Visibility --- */
    .tab-content-uebersicht,
    .tab-content-dokumente {
      display: none;
    }
    .tab-content-uebersicht.active,
    .tab-content-dokumente.active {
      display: block;
    }

    /* --- Shared Tab Container Styles --- */
    .tab-container { padding: 0; }
    .tab-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 0 16px 0;
    }
    .tab-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--neutral-900);
      margin: 0;
    }
    .tab-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 0 16px 0;
      gap: 16px;
    }
    .tab-search {
      display: flex;
      align-items: center;
      gap: 8px;
      background: white;
      border: 1px solid var(--neutral-300);
      border-radius: 6px;
      padding: 8px 12px;
      min-width: 240px;
    }
    .tab-search .material-icons-outlined {
      color: var(--neutral-400);
      font-size: 20px;
    }
    .tab-search input {
      border: none;
      outline: none;
      font-size: 14px;
      color: var(--neutral-700);
      background: transparent;
      width: 100%;
    }
    .tab-search input::placeholder { color: var(--neutral-400); }
    .tab-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* --- Shared Table Action Button Styles --- */
    .table-action-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border: none;
      background: transparent;
      color: var(--neutral-400);
      font-size: 14px;
      font-weight: 500;
      border-radius: 6px;
      cursor: not-allowed;
      transition: all 0.2s;
    }
    .table-action-btn .material-icons-outlined { font-size: 18px; }
    .table-action-btn.active {
      color: var(--neutral-600);
      cursor: pointer;
    }
    .table-action-btn.active:hover {
      background: var(--neutral-100);
      color: var(--neutral-900);
    }
    .table-btn-outline {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border: 1px solid var(--neutral-300);
      background: transparent;
      color: var(--neutral-700);
      font-size: 14px;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .table-btn-outline:hover {
      background: var(--neutral-100);
      border-color: var(--neutral-400);
    }
    .table-btn-outline .material-icons-outlined { font-size: 18px; }

    /* --- Shared Data Table Styles --- */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table th,
    .data-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--neutral-200);
    }
    .data-table th {
      font-size: 12px;
      font-weight: 600;
      color: var(--neutral-500);
      background: var(--neutral-100);
      white-space: nowrap;
    }
    .data-table td {
      font-size: 14px;
      color: var(--neutral-700);
    }
    .data-table tbody tr:hover td { background: var(--neutral-100); }
    .data-table tbody tr.selected td { background: var(--accent-50); }
    .data-table th.sortable {
      cursor: pointer;
      user-select: none;
    }
    .data-table th.sortable:hover { color: var(--neutral-700); }
    .data-table th .sort-icon {
      font-size: 16px;
      vertical-align: middle;
      margin-left: 2px;
      opacity: 0.5;
    }
    .data-table th.sortable:hover .sort-icon { opacity: 1; }
    .data-table-checkbox { width: 48px; }
    .data-table-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--accent-600);
    }

    /* --- Shared Empty State --- */
    .tab-empty {
      text-align: center;
      padding: 48px 24px;
      color: var(--neutral-500);
    }
    .tab-empty .material-icons-outlined {
      font-size: 48px;
      color: var(--neutral-300);
      margin-bottom: 16px;
    }

    /* --- Documents Tab Specific --- */
    .doc-title { font-weight: 500; }
    .doc-title a {
      color: var(--neutral-900);
      text-decoration: none;
      transition: color 0.2s;
    }
    .doc-title a:hover {
      color: var(--accent-600);
      text-decoration: underline;
    }
    .doc-type { color: var(--neutral-600); }
    .doc-format { color: var(--neutral-600); font-weight: 500; }
    .doc-uploaded { color: var(--neutral-500); font-size: 13px; }
    .doc-size { color: var(--neutral-600); text-align: right; white-space: nowrap; }

    /* --- Events Tab Specific --- */
    .tab-content-ereignisse { display: none; }
    .tab-content-ereignisse.active { display: block; }
    .event-milestone { font-weight: 500; color: var(--neutral-900); }
    .event-user { color: var(--neutral-700); }
    .event-timestamp { color: var(--neutral-500); }
    .event-comment { color: var(--neutral-500); font-style: italic; }

    /* --- Upload Dialog Overlay --- */
    .upload-dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .upload-dialog-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .upload-dialog {
      background: var(--neutral-50);
      border-radius: 12px;
      width: 100%;
      max-width: 480px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .upload-dialog-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--neutral-200);
    }
    .upload-dialog-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--neutral-900);
      margin: 0;
    }
    .upload-dialog-close {
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      cursor: pointer;
      color: var(--neutral-500);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .upload-dialog-close:hover {
      background: var(--neutral-100);
    }
    .upload-step {
      padding: 16px 24px;
    }
    .upload-step:first-of-type {
      padding-top: 24px;
    }
    .upload-step-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--neutral-700);
      margin-bottom: 8px;
    }
    .upload-dropzone {
      border: 2px dashed var(--neutral-300);
      border-radius: 8px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .upload-dropzone:hover {
      border-color: var(--accent-600);
      background: var(--accent-100);
    }
    .upload-dropzone.dragover {
      border-color: var(--accent-600);
      background: var(--accent-100);
    }
    .upload-dropzone.has-file {
      border-color: var(--accent-600);
      border-style: solid;
      background: var(--accent-100);
    }
    .upload-dropzone-text {
      color: var(--neutral-500);
      font-size: 14px;
    }
    .upload-dropzone-filename {
      color: var(--accent-600);
      font-weight: 500;
    }
    .upload-select {
      width: 100%;
      padding: 10px 12px;
      font-size: 14px;
      border: 1px solid var(--neutral-300);
      border-radius: 6px;
      background: var(--neutral-50);
      color: var(--neutral-700);
      cursor: pointer;
    }
    .upload-select:focus {
      outline: none;
      border-color: var(--accent-600);
    }
    .upload-input {
      width: 100%;
      padding: 10px 12px;
      font-size: 14px;
      border: 1px solid var(--neutral-300);
      border-radius: 6px;
      background: var(--neutral-50);
      color: var(--neutral-700);
      box-sizing: border-box;
    }
    .upload-input:focus {
      outline: none;
      border-color: var(--accent-600);
    }
    .upload-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      padding: 20px 24px;
      border-top: 1px solid var(--neutral-200);
    }
    .upload-btn-cancel {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      border: 1px solid var(--neutral-300);
      background: var(--neutral-50);
      color: var(--neutral-700);
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .upload-btn-cancel:hover {
      background: var(--neutral-100);
    }
    .upload-btn-submit {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      border: none;
      background: var(--accent-600);
      color: var(--neutral-50);
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s, opacity 0.2s;
    }
    .upload-btn-submit:hover:not(:disabled) {
      background: var(--accent-500);
    }
    .upload-btn-submit:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* --- Login Dialog Styles --- */
    .login-dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .login-dialog-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .login-dialog {
      background: var(--neutral-50);
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .login-dialog-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--neutral-200);
    }
    .login-dialog-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--neutral-900);
      margin: 0;
    }
    .login-dialog-close {
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      cursor: pointer;
      color: var(--neutral-500);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .login-dialog-close:hover {
      background: var(--neutral-100);
    }
    .login-form {
      padding: 24px;
    }
    .login-field {
      margin-bottom: 16px;
    }
    .login-field:last-of-type {
      margin-bottom: 0;
    }
    .login-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--neutral-700);
      margin-bottom: 6px;
    }
    .login-input {
      width: 100%;
      padding: 10px 12px;
      font-size: 14px;
      border: 1px solid var(--neutral-300);
      border-radius: 6px;
      background: var(--neutral-50);
      color: var(--neutral-700);
      box-sizing: border-box;
    }
    .login-input:focus {
      outline: none;
      border-color: var(--accent-600);
    }
    .login-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      padding: 20px 24px;
      border-top: 1px solid var(--neutral-200);
    }
    .login-btn-cancel {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      border: 1px solid var(--neutral-300);
      background: var(--neutral-50);
      color: var(--neutral-700);
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .login-btn-cancel:hover {
      background: var(--neutral-100);
    }
    .login-btn-submit {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      border: none;
      background: var(--accent-600);
      color: var(--neutral-50);
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .login-btn-submit:hover {
      background: var(--accent-500);
    }
    .login-links {
      display: flex;
      justify-content: space-between;
      padding: 0 24px 16px;
    }
    .login-link {
      font-size: 13px;
      color: var(--accent-600);
      text-decoration: none;
      cursor: pointer;
    }
    .login-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <div class="logo">C</div>
      <div class="header-title">
        <span class="header-title-main">Verkaufsplattform</span>
        <span class="header-title-sub">Bundesamt für Bauten und Logistik</span>
      </div>
    </div>
    <div class="header-right">
      <button class="btn btn-primary">Auftrag erstellen</button>
      <button class="btn btn-outline" onclick="openLoginDialog()">Login</button>
    </div>
  </header>

  <div class="search-section">
    <div class="search-section-inner">
      <div class="search-row">
        <div class="search-input-wrapper">
          <span class="material-icons-outlined">search</span>
          <input type="text" class="search-input" id="searchInput" placeholder="Suche nach Bezeichnung, Adresse, oder Wirtschaftseinheit">
        </div>
        <div class="view-toggle">
          <button class="view-btn" data-view="map" title="Karte"><span class="material-icons-outlined">map</span></button>
          <button class="view-btn" data-view="list" title="Liste"><span class="material-icons-outlined">reorder</span><span class="view-btn-label">Liste</span></button>
          <button class="view-btn active" data-view="gallery" title="Galerie"><span class="material-icons-outlined">grid_view</span></button>
        </div>
      </div>
      <div class="filter-row">
        <div class="filter-pills" id="filterPills"></div>
        <div class="filter-right">
          <div class="stats-count"><span id="objectCount">0</span> Objekte</div>
          <button class="filter-btn" id="filterBtn">
            <span>Filter</span>
            <span class="filter-count" id="filterCount" style="display: none;">0</span>
            <span class="material-icons-outlined">tune</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <main class="main">
    <div class="view-container active" id="galleryView">
      <div class="grid" id="objectGrid"></div>
    </div>

    <div class="view-container" id="listView">
      <div class="stats-boxes" id="statsBoxes">
        <div class="stats-box"><div class="stats-box-value" id="statsTotalObjects">0</div><div class="stats-box-label">Anzahl Objekte</div></div>
        <div class="stats-box"><div class="stats-box-value" id="statsHighPriority">0</div><div class="stats-box-label">Hohe Priorität</div></div>
        <div class="stats-box"><div class="stats-box-value" id="statsNormalPriority">0</div><div class="stats-box-label">Normale Priorität</div></div>
        <div class="stats-box"><div class="stats-box-value" id="statsLowPriority">0</div><div class="stats-box-label">Geringe Priorität</div></div>
        <div class="stats-box stats-box-download" onclick="exportToExcel()"><span class="material-icons-outlined">download</span><div class="stats-box-label">Excel Download</div></div>
      </div>
      <div class="list-table-container">
        <table class="list-table">
          <thead><tr><th></th><th>ID</th><th>Objekt</th><th>Verkaufsjahr</th><th>Priorisierung</th><th>Meilenstein</th><th>Objekt Fläche</th><th>Marktwert</th></tr></thead>
          <tbody id="listTableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="map-container" id="mapView">
      <div class="map-sidebar" id="mapSidebar"></div>
      <div class="map-area">
        <div id="map"></div>
      </div>
    </div>
  </main>

  <!-- Detail View (Single Page) -->
  <div class="detail-view" id="detailView">
    <div class="detail-header">
      <div class="detail-header-inner">
        <span class="detail-breadcrumb" id="detailBreadcrumb"></span>
        <div class="detail-header-actions">
          <button class="detail-pdf-btn" onclick="exportToPdf()">Als PDF exportieren</button>
          <button class="detail-back-btn" onclick="closeDetailPage()">
            <span class="material-icons-outlined">arrow_back</span>
            Zurück zur Übersicht
          </button>
        </div>
      </div>
    </div>
    <div class="detail-content" id="detailContent">
      <!-- Content will be rendered by JavaScript -->
    </div>
  </div>

  <!-- Filter Modal -->
  <div class="filter-modal-overlay" id="filterModalOverlay">
    <div class="filter-modal">
      <div class="filter-modal-header">
        <h2>Suchfilter</h2>
        <div class="filter-modal-actions">
          <button class="filter-reset-btn" id="filterResetBtn" title="Filter zurücksetzen">
            <span class="material-icons-outlined">refresh</span>
          </button>
          <button class="filter-close-btn" id="filterCloseBtn">
            <span class="material-icons-outlined">close</span>
          </button>
        </div>
      </div>
      <div class="filter-modal-body">
        <div class="filter-columns">
          <div class="filter-column">
            <h3 class="filter-column-title">Nutzung</h3>
            <div class="filter-options" id="filterNutzung"></div>
          </div>
          <div class="filter-column">
            <h3 class="filter-column-title">Verkaufsjahr</h3>
            <div class="filter-options" id="filterYear"></div>
          </div>
          <div class="filter-column">
            <h3 class="filter-column-title">Priorisierung</h3>
            <div class="filter-options" id="filterPriority"></div>
          </div>
          <div class="filter-column">
            <h3 class="filter-column-title">Meilenstein</h3>
            <div class="filter-options" id="filterMilestone"></div>
          </div>
          <div class="filter-column">
            <h3 class="filter-column-title">Portfolio</h3>
            <div class="filter-options" id="filterPortfolio"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Carousel -->
  <div class="carousel-overlay" id="carouselOverlay">
    <div class="carousel-header">
      <span class="carousel-counter" id="carouselCounter">1 / 5</span>
      <button class="carousel-close-btn" onclick="closeCarousel()" title="Schliessen (Esc)">
        <span class="material-icons-outlined">close</span>
      </button>
    </div>
    <div class="carousel-main" onclick="if(event.target === this) closeCarousel()">
      <button class="carousel-nav-btn prev" onclick="navigateCarousel(-1)" title="Vorheriges Bild">
        <span class="material-icons-outlined">chevron_left</span>
      </button>
      <div class="carousel-image-container">
        <img class="carousel-image" id="carouselImage" src="" alt="Bild">
      </div>
      <button class="carousel-nav-btn next" onclick="navigateCarousel(1)" title="Nächstes Bild">
        <span class="material-icons-outlined">chevron_right</span>
      </button>
    </div>
    <div class="carousel-thumbnails" id="carouselThumbnails"></div>
  </div>

  <!-- Upload Document Dialog -->
  <div class="upload-dialog-overlay" id="uploadDialogOverlay" onclick="if(event.target === this) closeUploadDialog()">
    <div class="upload-dialog">
      <div class="upload-dialog-header">
        <h3 class="upload-dialog-title">Dokument hochladen</h3>
        <button class="upload-dialog-close" onclick="closeUploadDialog()" aria-label="Schliessen">
          <span class="material-icons-outlined">close</span>
        </button>
      </div>

      <div class="upload-step">
        <div class="upload-step-label">1. Datei auswählen</div>
        <div class="upload-dropzone" id="uploadDropzone" onclick="document.getElementById('uploadFileInput').click()">
          <span id="uploadDropzoneText" class="upload-dropzone-text">Datei auswählen</span>
        </div>
        <input type="file" id="uploadFileInput" style="display: none;" onchange="handleFileSelect(this.files[0])">
      </div>

      <div class="upload-step">
        <div class="upload-step-label">2. Art der Datei auswählen</div>
        <select class="upload-select" id="uploadTypeSelect" onchange="validateUploadForm()">
          <option value="">Choose an option...</option>
          <option value="3D-Modelldaten">3D-Modelldaten</option>
          <option value="Ansichtsplan">Ansichtsplan</option>
          <option value="Auszug ÖREB-Kataster">Auszug ÖREB-Kataster</option>
          <option value="Akte zu Unterhalt">Akte zu Unterhalt</option>
          <option value="Grundrissplan">Grundrissplan</option>
          <option value="Indikative Marktwertbewertung">Indikative Marktwertbewertung</option>
          <option value="Kauf- Dienstbarkeitsvertrag">Kauf- Dienstbarkeitsvertrag</option>
          <option value="Mieterdossier">Mieterdossier</option>
          <option value="Mietvertrag">Mietvertrag</option>
          <option value="Schliessplan / Sicherungsschein">Schliessplan / Sicherungsschein</option>
          <option value="Serviceverträge">Serviceverträge</option>
          <option value="Sonstiges">Sonstiges</option>
        </select>
      </div>

      <div class="upload-step">
        <div class="upload-step-label">3. Dateiname</div>
        <input type="text" class="upload-input" id="uploadNameInput" placeholder="Dateiname eingeben" oninput="validateUploadForm()">
      </div>

      <div class="upload-actions">
        <button class="upload-btn-cancel" onclick="closeUploadDialog()">Abbrechen</button>
        <button class="upload-btn-submit" id="uploadSubmitBtn" onclick="submitDocumentUpload()" disabled>Hochladen</button>
      </div>
    </div>
  </div>

  <!-- Login Dialog -->
  <div class="login-dialog-overlay" id="loginDialogOverlay" onclick="if(event.target === this) closeLoginDialog()">
    <div class="login-dialog">
      <div class="login-dialog-header">
        <h3 class="login-dialog-title">Anmelden</h3>
        <button class="login-dialog-close" onclick="closeLoginDialog()" aria-label="Schliessen">
          <span class="material-icons-outlined">close</span>
        </button>
      </div>

      <div class="login-form">
        <div class="login-field">
          <label class="login-label" for="loginEmail">E-Mail</label>
          <input type="email" class="login-input" id="loginEmail" placeholder="name@beispiel.ch">
        </div>

        <div class="login-field">
          <label class="login-label" for="loginPassword">Passwort</label>
          <input type="password" class="login-input" id="loginPassword" placeholder="Passwort eingeben">
        </div>
      </div>

      <div class="login-links">
        <a class="login-link" onclick="alert('Funktion noch nicht verfügbar')">Kennwort vergessen?</a>
        <a class="login-link" onclick="alert('Funktion noch nicht verfügbar')">Neu registrieren</a>
      </div>

      <div class="login-actions">
        <button class="login-btn-cancel" onclick="closeLoginDialog()">Abbrechen</button>
        <button class="login-btn-submit" onclick="submitLogin()">Anmelden</button>
      </div>
    </div>
  </div>

  <footer class="footer">
    <a href="https://github.com/davras5/transaction-immo" class="footer-link" target="_blank" rel="noopener noreferrer">Quellcode</a>
    <a href="https://www.admin.ch/gov/de/start/rechtliches.html" class="footer-link" target="_blank" rel="noopener noreferrer">Rechtliches</a>
  </footer>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiZGF2aWRyYXNuZXI1IiwiYSI6ImNtMm5yamVkdjA5MDcycXMyZ2I2MHRhamgifQ.m651j7WIX7MyxNh8KIQ1Gg';

    let properties = [];
    let filteredProperties = [];
    let searchQuery = '';
    let currentView = 'gallery';
    let map = null;
    let mapLoaded = false;
    let markers = [];
    let markersMap = new Map();

    // Advanced filter state
    let advancedFilters = {
      type: new Set(),        // Nutzung
      year: new Set(),        // Verkaufsjahr
      priority: new Set(),    // Priorisierung
      milestone: new Set(),   // Meilenstein
      portfolio: new Set()    // Portfolio
    };

    // Unique values from data (populated after load)
    let filterOptions = {
      type: [],
      year: [],
      priority: [],
      milestone: [],
      portfolio: []
    };

    // Carousel state
    let carouselImages = [];
    let carouselIndex = 0;

    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        view: params.get('view'),
        id: params.get('id'),
        q: params.get('q'),
        type: params.get('type'),
        year: params.get('year'),
        priority: params.get('priority'),
        milestone: params.get('milestone'),
        portfolio: params.get('portfolio')
      };
    }

    function updateUrlParams() {
      const params = new URLSearchParams();
      if (currentView !== 'gallery') params.set('view', currentView);
      if (searchQuery) params.set('q', searchQuery);

      // Add all advanced filters
      Object.keys(advancedFilters).forEach(key => {
        if (advancedFilters[key].size > 0) {
          params.set(key, Array.from(advancedFilters[key]).join(','));
        }
      });

      const newUrl = params.toString() ? `${window.location.pathname}?${params.toString()}` : window.location.pathname;
      window.history.replaceState({}, '', newUrl);
    }

    function loadFiltersFromUrl() {
      const params = getUrlParams();
      if (params.view && ['gallery', 'list', 'map'].includes(params.view)) currentView = params.view;
      if (params.q) {
        searchQuery = params.q;
        document.getElementById('searchInput').value = searchQuery;
      }

      // Load all advanced filters from URL
      ['type', 'year', 'priority', 'milestone', 'portfolio'].forEach(key => {
        if (params[key]) {
          params[key].split(',').forEach(val => advancedFilters[key].add(val));
        }
      });
    }

    function getPriorityClass(priority) { return (priority === null || priority === undefined) ? 'priority-null' : `priority-${priority}`; }
    function getPriorityLabel(priority, priorityLabel) { return (priority === null || priority === undefined) ? 'Keine Angabe' : priorityLabel; }
    function getPriorityValue(priority) { return (priority === null || priority === undefined) ? 'null' : String(priority); }
    function formatCHF(value) { return (!value) ? 'CHF 0' : 'CHF ' + value.toLocaleString('de-CH').replace(/,/g, "'"); }
    function formatNumber(value) { return (!value && value !== 0) ? '0' : value.toLocaleString('de-CH').replace(/,/g, "'"); }
    function formatPriceRange(min, max) { return ((!min) && (!max)) ? 'CHF 0 - CHF 0' : formatCHF(min) + ' - ' + formatCHF(max); }
    function pricePerSqm(price, area) { return (!price || !area) ? 0 : Math.round(price / area); }
    function formatCoord(value, dir) {
      if (!value) return '-';
      const abs = Math.abs(value);
      const deg = Math.floor(abs);
      const minFloat = (abs - deg) * 60;
      const min = Math.floor(minFloat);
      const sec = ((minFloat - min) * 60).toFixed(1);
      return `${deg}°${min}'${sec}"${dir}`;
    }

    function getPlaceholderImage(type, id) {
      const idStr = String(id);
      const hash = idStr.split('').reduce((a, b) => { a = ((a << 5) - a) + b.charCodeAt(0); return a & a; }, 0);
      const imageIndex = Math.abs(hash) % 5;
      const images = ['https://images.unsplash.com/photo-1568605114967-8130f3a36994', 'https://images.unsplash.com/photo-1570129477492-45c003edd2be', 'https://images.unsplash.com/photo-1564013799919-ab600027ffc6', 'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab', 'https://images.unsplash.com/photo-1581094794329-c8112a89af12'];
      return images[imageIndex] + '?w=400&h=300&fit=crop';
    }

    // Extract unique filter options from data
    function extractFilterOptions() {
      const types = new Set();
      const years = new Set();
      const priorities = new Map(); // value -> label
      const milestones = new Map(); // current/total -> label
      const portfolios = new Set();

      properties.forEach(prop => {
        if (prop.type) types.add(prop.type);
        if (prop.year) years.add(prop.year);

        const pKey = prop.priority !== null && prop.priority !== undefined ? String(prop.priority) : 'null';
        const pLabel = getPriorityLabel(prop.priority, prop.priorityLabel);
        priorities.set(pKey, pLabel);

        if (prop.milestone) {
          const mKey = `${prop.milestone.current}/${prop.milestone.total}`;
          milestones.set(mKey, prop.milestone.label);
        }

        if (prop.portfolio) portfolios.add(prop.portfolio);
      });

      filterOptions.type = Array.from(types).sort();
      filterOptions.year = Array.from(years).sort((a, b) => a - b);
      filterOptions.priority = Array.from(priorities.entries()).map(([value, label]) => ({ value, label }));
      filterOptions.milestone = Array.from(milestones.entries()).map(([value, label]) => ({ value, label }));
      filterOptions.portfolio = Array.from(portfolios).sort();
    }

    // Check if any filters are active
    function hasActiveFilters() {
      return Object.values(advancedFilters).some(set => set.size > 0) || searchQuery;
    }

    // Count total active filters (excluding search)
    function getActiveFilterCount() {
      let count = 0;
      Object.values(advancedFilters).forEach(set => count += set.size);
      return count;
    }

    // Get priority counts from all properties
    function getPriorityCounts() {
      const counts = { '0': 0, '1': 0, '2': 0, '3': 0, 'null': 0 };
      properties.forEach(prop => {
        const pKey = prop.priority !== null && prop.priority !== undefined ? String(prop.priority) : 'null';
        if (counts.hasOwnProperty(pKey)) counts[pKey]++;
      });
      return counts;
    }

    // Update the filter button appearance and count
    function updateFilterButtonState() {
      const btn = document.getElementById('filterBtn');
      const countEl = document.getElementById('filterCount');
      const count = getActiveFilterCount();

      if (count > 0) {
        btn.classList.add('has-filters');
        countEl.textContent = count;
        countEl.style.display = 'inline';
      } else {
        btn.classList.remove('has-filters');
        countEl.style.display = 'none';
      }
    }

    // Render priority pills and reset button
    function renderPriorityPills() {
      const container = document.getElementById('filterPills');
      const counts = getPriorityCounts();

      // Priority labels mapping
      const priorityLabels = {
        '0': 'Hohe Priorität',
        '1': 'Normale Priorität',
        '2': 'Geringe Priorität',
        '3': 'Keine Priorität',
        'null': 'Keine Angabe'
      };

      // Build pills HTML
      let html = ['0', '1', '2', '3', 'null'].map(pKey => {
        const isActive = advancedFilters.priority.has(pKey);
        return `
          <button class="filter-pill ${isActive ? 'active' : ''}" data-priority="${pKey}">
            ${priorityLabels[pKey]} (${counts[pKey]})
            <span class="material-icons-outlined close-icon">close</span>
          </button>
        `;
      }).join('');

      // Add reset button
      html += `
        <button class="reset-filters ${hasActiveFilters() ? 'visible' : ''}" id="resetFilters" title="Alle Filter zurücksetzen">
          <span class="material-icons-outlined">replay</span>
        </button>
      `;

      container.innerHTML = html;

      // Add click handlers for priority pills
      container.querySelectorAll('.filter-pill').forEach(pill => {
        pill.addEventListener('click', () => {
          const priority = pill.dataset.priority;
          if (advancedFilters.priority.has(priority)) {
            advancedFilters.priority.delete(priority);
          } else {
            advancedFilters.priority.add(priority);
          }
          applyFilters();
          renderFilterModal();
        });
      });

      // Add click handler for reset button
      const resetBtn = container.querySelector('#resetFilters');
      if (resetBtn) {
        resetBtn.addEventListener('click', resetAllFilters);
      }
    }

    // Reset all filters
    function resetAllFilters() {
      Object.keys(advancedFilters).forEach(key => advancedFilters[key].clear());
      searchQuery = '';
      document.getElementById('searchInput').value = '';
      applyFilters();
      if (document.getElementById('filterModalOverlay').classList.contains('active')) {
        renderFilterModal();
      }
    }

    // Apply all filters
    function applyFilters() {
      filteredProperties = properties.filter(prop => {
        // Search query filter
        if (searchQuery) {
          const query = searchQuery.toLowerCase();
          const searchFields = [prop.econUnit, prop.bldgNum, prop.title, prop.type, prop.city, prop.zip, prop.address, prop.canton].map(f => (f || '').toString().toLowerCase());
          if (!searchFields.some(field => field.includes(query))) return false;
        }

        // Type filter (OR within category)
        if (advancedFilters.type.size > 0 && !advancedFilters.type.has(prop.type)) {
          return false;
        }

        // Year filter (OR within category)
        if (advancedFilters.year.size > 0 && !advancedFilters.year.has(String(prop.year))) {
          return false;
        }

        // Priority filter (OR within category)
        if (advancedFilters.priority.size > 0) {
          const pKey = prop.priority !== null && prop.priority !== undefined ? String(prop.priority) : 'null';
          if (!advancedFilters.priority.has(pKey)) return false;
        }

        // Milestone filter (OR within category)
        if (advancedFilters.milestone.size > 0) {
          const mKey = prop.milestone ? `${prop.milestone.current}/${prop.milestone.total}` : '';
          if (!advancedFilters.milestone.has(mKey)) return false;
        }

        // Portfolio filter (OR within category)
        if (advancedFilters.portfolio.size > 0 && !advancedFilters.portfolio.has(prop.portfolio)) {
          return false;
        }

        return true;
      });

      if (currentView === 'gallery') renderCards();
      else if (currentView === 'list') renderListView();
      else if (currentView === 'map') renderMapView();

      updateUrlParams();
      updateFilterButtonState();
      renderPriorityPills();
    }

    // Render filter modal options
    function renderFilterModal() {
      // Helper to create option HTML with close icon
      const createOption = (isSelected, filterKey, value, label) => `
        <div class="filter-option ${isSelected ? 'selected' : ''}" data-filter="${filterKey}" data-value="${value}">
          <span>${label}</span>
          <span class="material-icons-outlined close-icon">close</span>
        </div>
      `;

      // Nutzung (type)
      const typeContainer = document.getElementById('filterNutzung');
      typeContainer.innerHTML = filterOptions.type.map(t =>
        createOption(advancedFilters.type.has(t), 'type', t, t)
      ).join('');

      // Verkaufsjahr (year)
      const yearContainer = document.getElementById('filterYear');
      yearContainer.innerHTML = filterOptions.year.map(y =>
        createOption(advancedFilters.year.has(String(y)), 'year', y, y)
      ).join('');

      // Priorisierung (priority) - show all 5 options
      const priorityContainer = document.getElementById('filterPriority');
      const priorityLabels = {
        '0': 'Hohe Priorität',
        '1': 'Normale Priorität',
        '2': 'Geringe Priorität',
        '3': 'Keine Priorität',
        'null': 'Keine Angabe'
      };
      priorityContainer.innerHTML = ['0', '1', '2', '3', 'null'].map(pKey =>
        createOption(advancedFilters.priority.has(pKey), 'priority', pKey, priorityLabels[pKey])
      ).join('');

      // Meilenstein (milestone)
      const milestoneContainer = document.getElementById('filterMilestone');
      milestoneContainer.innerHTML = filterOptions.milestone.map(m =>
        createOption(advancedFilters.milestone.has(m.value), 'milestone', m.value, `${m.value} ${m.label}`)
      ).join('');

      // Portfolio
      const portfolioContainer = document.getElementById('filterPortfolio');
      portfolioContainer.innerHTML = filterOptions.portfolio.map(p =>
        createOption(advancedFilters.portfolio.has(p), 'portfolio', p, p)
      ).join('');

      // Add click handlers
      document.querySelectorAll('.filter-modal .filter-option').forEach(opt => {
        opt.addEventListener('click', () => {
          const filterKey = opt.dataset.filter;
          const filterValue = opt.dataset.value;

          if (advancedFilters[filterKey].has(filterValue)) {
            advancedFilters[filterKey].delete(filterValue);
            opt.classList.remove('selected');
          } else {
            advancedFilters[filterKey].add(filterValue);
            opt.classList.add('selected');
          }

          applyFilters();
          // Update close icons visibility
          renderFilterModal();
        });
      });
    }

    // Filter Modal open/close
    function openFilterModal() {
      renderFilterModal();
      document.getElementById('filterModalOverlay').classList.add('active');
      document.getElementById('filterBtn').classList.add('panel-open');
      document.body.style.overflow = 'hidden';
    }

    function closeFilterModal() {
      document.getElementById('filterModalOverlay').classList.remove('active');
      document.getElementById('filterBtn').classList.remove('panel-open');
      document.body.style.overflow = '';
    }

    // --- Image Carousel Functions ---
    function openCarousel(images, startIndex = 0) {
      carouselImages = images;
      carouselIndex = startIndex;
      updateCarouselView();
      document.getElementById('carouselOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeCarousel() {
      document.getElementById('carouselOverlay').classList.remove('active');
      document.body.style.overflow = '';
    }

    function navigateCarousel(direction) {
      const newIndex = carouselIndex + direction;
      if (newIndex >= 0 && newIndex < carouselImages.length) {
        carouselIndex = newIndex;
        updateCarouselView();
      }
    }

    function goToCarouselImage(index) {
      if (index >= 0 && index < carouselImages.length) {
        carouselIndex = index;
        updateCarouselView();
      }
    }

    function updateCarouselView() {
      // Update counter
      document.getElementById('carouselCounter').textContent = `${carouselIndex + 1} / ${carouselImages.length}`;

      // Update main image with higher resolution
      const currentImage = carouselImages[carouselIndex].replace('w=400&h=300', 'w=1200&h=900');
      document.getElementById('carouselImage').src = currentImage;

      // Update navigation buttons
      document.querySelector('.carousel-nav-btn.prev').disabled = carouselIndex === 0;
      document.querySelector('.carousel-nav-btn.next').disabled = carouselIndex === carouselImages.length - 1;

      // Update thumbnails
      const thumbsContainer = document.getElementById('carouselThumbnails');
      thumbsContainer.innerHTML = carouselImages.map((img, idx) => `
        <div class="carousel-thumb ${idx === carouselIndex ? 'active' : ''}"
             style="background-image: url('${img}')"
             onclick="goToCarouselImage(${idx})"></div>
      `).join('');
    }

    function getDataToRender() { return (filteredProperties.length > 0 || hasActiveFilters()) ? filteredProperties : properties; }

    function renderCards() {
      const grid = document.getElementById('objectGrid');
      const data = getDataToRender();
      document.getElementById('objectCount').textContent = data.length;
      grid.innerHTML = data.map(prop => `
        <div class="card" data-id="${prop.id}">
          <div class="card-image" style="background-image: url('${getPlaceholderImage(prop.type, prop.id)}')">
            <div class="image-tags">
              <span class="year-tag" data-filter="year" data-value="${prop.year}">${prop.year}</span>
              <span class="priority-tag ${getPriorityClass(prop.priority)}" data-filter="priority" data-value="${getPriorityValue(prop.priority)}">${getPriorityLabel(prop.priority, prop.priorityLabel)}</span>
            </div>
          </div>
          <div class="card-content">
            <div class="card-label">${prop.econUnit}/${prop.bldgNum} ${prop.type}</div>
            <div class="card-location">In ${prop.zip} ${prop.city}</div>
            <div class="card-price">${formatPriceRange(prop.valueMin, prop.valueMax)}</div>
            <div class="card-price-sqm">${formatCHF(pricePerSqm(prop.valueMin, prop.areaGF))} - ${formatCHF(pricePerSqm(prop.valueMax, prop.areaGF))} / m² GF</div>
            <div class="card-details">
              <span class="card-detail-label">Geschossfläche GF:</span><span class="card-detail-value">${prop.areaGF} m²</span>
              <span class="card-detail-label">Buchwert:</span><span class="card-detail-value">${formatCHF(prop.bookValue)}</span>
            </div>
            <div class="card-milestone">
              <div class="milestone-bar"><div class="milestone-progress" style="width: ${(prop.milestone.current / prop.milestone.total) * 100}%"></div></div>
              <div class="milestone-text">Meilenstein ${prop.milestone.current}/${prop.milestone.total} ${prop.milestone.label}</div>
            </div>
          </div>
        </div>`).join('');
    }

    function renderListView() {
      const data = getDataToRender();
      document.getElementById('objectCount').textContent = data.length;
      const stats = { total: data.length, high: 0, normal: 0, low: 0 };
      data.forEach(p => {
        if (p.priorityLabel === 'Hohe Priorität') stats.high++;
        else if (p.priorityLabel === 'Normale Priorität') stats.normal++;
        else if (p.priorityLabel === 'Geringe Priorität') stats.low++;
      });
      document.getElementById('statsTotalObjects').textContent = stats.total;
      document.getElementById('statsHighPriority').textContent = stats.high;
      document.getElementById('statsNormalPriority').textContent = stats.normal;
      document.getElementById('statsLowPriority').textContent = stats.low;

      const tbody = document.getElementById('listTableBody');
      tbody.innerHTML = data.map(prop => `
        <tr data-id="${prop.id}">
          <td><span class="material-icons-outlined object-icon">home</span></td>
          <td>${prop.econUnit}/${prop.bldgNum}</td>
          <td>${prop.type} in ${prop.zip} ${prop.city}</td>
          <td><span class="year-tag" data-filter="year" data-value="${prop.year}">${prop.year}</span></td>
          <td><span class="priority-tag ${getPriorityClass(prop.priority)}" data-filter="priority" data-value="${getPriorityValue(prop.priority)}">${getPriorityLabel(prop.priority, prop.priorityLabel)}</span></td>
          <td>${prop.milestone.current}/${prop.milestone.total} ${prop.milestone.label}</td>
          <td>${prop.areaGF} m²</td>
          <td>${formatPriceRange(prop.valueMin, prop.valueMax)}</td>
        </tr>`).join('');
    }

    // --- REPAIRED SIDEBAR RENDER FUNCTION ---
    function renderMapView() {
      const data = getDataToRender();
      document.getElementById('objectCount').textContent = data.length;
      const sidebar = document.getElementById('mapSidebar');
      
      // Neue Struktur: Bild-Container mit Tags (Overlay) -> Inhalt (Name + Preis)
      sidebar.innerHTML = data.map(prop => `
        <div class="map-sidebar-item" data-id="${prop.id}">
          <div class="map-sidebar-image" style="background-image: url('${getPlaceholderImage(prop.type, prop.id)}')">
            <div class="image-tags">
              <span class="year-tag" data-filter="year" data-value="${prop.year}">${prop.year}</span>
              <span class="priority-tag ${getPriorityClass(prop.priority)}" data-filter="priority" data-value="${getPriorityValue(prop.priority)}">${getPriorityLabel(prop.priority, prop.priorityLabel)}</span>
            </div>
          </div>
          <div class="map-sidebar-content">
            <div class="map-sidebar-title">${prop.type} in ${prop.zip} ${prop.city}</div>
            <div class="map-sidebar-price">${formatPriceRange(prop.valueMin, prop.valueMax)}</div>
          </div>
        </div>`).join('');

      if (!map) {
        initializeMap();
      } else if (mapLoaded) {
        updateMapMarkers(data);
      }
      // Wenn map existiert aber noch nicht geladen ist,
      // werden die Marker automatisch beim 'load'-Event aktualisiert
    }

    function flyToProperty(id) {
      const prop = properties.find(p => p.id === id);
      if (!prop || !prop.lat || !prop.lng) return;
      document.querySelectorAll('.map-sidebar-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.id === id) item.classList.add('active');
      });
      document.querySelectorAll('.marker').forEach(m => m.classList.remove('selected'));
      const md = markersMap.get(id);
      if (md) {
        md.marker.getElement().classList.add('selected');
        map.flyTo({ center: [prop.lng, prop.lat], zoom: 13, duration: 1500 });
        setTimeout(() => {
          const popup = md.marker.getPopup();
          if (popup && !popup.isOpen()) {
            md.marker.togglePopup();
          }
        }, 1600);
      }
    }

    function initializeMap() {
      map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v11',
        center: [8.2275, 46.8182], zoom: 7
      });
      map.addControl(new mapboxgl.NavigationControl(), 'top-right');
      map.on('load', () => {
        mapLoaded = true;
        updateMapMarkers(getDataToRender());
      });
    }

    function updateMapMarkers(data) {
      markers.forEach(marker => marker.remove());
      markers = []; markersMap.clear();
      const bounds = new mapboxgl.LngLatBounds();
      data.forEach(prop => {
        if (prop.lat && prop.lng) {
          const el = document.createElement('div');
          el.className = `marker marker-${prop.priority !== null ? prop.priority : 'null'}`;
          el.innerHTML = '<span class="material-icons-outlined">home</span>';
          el.addEventListener('click', () => {
            document.querySelectorAll('.marker').forEach(m => m.classList.remove('selected'));
            el.classList.add('selected');
            flyToProperty(prop.id);
          });

          const popup = new mapboxgl.Popup({ offset: 25, maxWidth: '280px' }).setHTML(`
            <div class="popup-image" style="background-image: url('${getPlaceholderImage(prop.type, prop.id)}')"></div>
            <div class="popup-content">
              <div class="popup-title">${prop.type}</div>
              <div class="popup-location">${prop.address}, ${prop.city}</div>
              <div class="popup-price">${formatPriceRange(prop.valueMin, prop.valueMax)}</div>
              <div class="popup-link" onclick="openDetailPage('${prop.id}')">Details anzeigen</div>
            </div>`);

          const marker = new mapboxgl.Marker(el).setLngLat([prop.lng, prop.lat]).setPopup(popup).addTo(map);
          markers.push(marker);
          markersMap.set(prop.id, { marker, prop });
          bounds.extend([prop.lng, prop.lat]);
        }
      });
      if (markers.length > 0) map.fitBounds(bounds, { padding: 80, maxZoom: 10 });
    }

    function setView(view) {
      currentView = view;
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
        const label = btn.querySelector('.view-btn-label');
        if (label) label.remove();
      });
      const activeBtn = document.querySelector(`.view-btn[data-view="${view}"]`);
      if (activeBtn) {
        activeBtn.classList.add('active');
        const label = document.createElement('span');
        label.className = 'view-btn-label';
        label.textContent = { gallery: 'Galerie', list: 'Liste', map: 'Karte' }[view];
        activeBtn.appendChild(label);
      }

      document.getElementById('galleryView').classList.remove('active');
      document.getElementById('listView').classList.remove('active');
      document.getElementById('mapView').classList.remove('active');

      if (view === 'gallery') {
        document.getElementById('galleryView').classList.add('active');
        renderCards();
      } else if (view === 'list') {
        document.getElementById('listView').classList.add('active');
        renderListView();
      } else if (view === 'map') {
        document.getElementById('mapView').classList.add('active');
        renderMapView();
        setTimeout(() => { if (map) map.resize(); }, 150);
      }
      updateUrlParams();
    }

    function setupViewToggle() {
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const view = btn.dataset.view;
          if (view) setView(view);
        });
      });
    }

    function exportToExcel() { alert('Excel Export Placeholder'); }

    function setupFilterModal() {
      // Open filter modal
      document.getElementById('filterBtn').addEventListener('click', openFilterModal);

      // Close filter modal
      document.getElementById('filterCloseBtn').addEventListener('click', closeFilterModal);
      document.getElementById('filterModalOverlay').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeFilterModal();
      });

      // Reset filters button in modal
      document.getElementById('filterResetBtn').addEventListener('click', () => {
        resetAllFilters();
      });

      // Keyboard navigation (handles carousel, filter modal, and detail view)
      document.addEventListener('keydown', (e) => {
        const carouselActive = document.getElementById('carouselOverlay').classList.contains('active');

        // Carousel keyboard controls
        if (carouselActive) {
          if (e.key === 'Escape') {
            closeCarousel();
          } else if (e.key === 'ArrowLeft') {
            navigateCarousel(-1);
          } else if (e.key === 'ArrowRight') {
            navigateCarousel(1);
          }
          return;
        }

        // Other Escape handlers
        if (e.key === 'Escape') {
          if (document.getElementById('filterModalOverlay').classList.contains('active')) {
            closeFilterModal();
          } else if (document.getElementById('detailView').classList.contains('active')) {
            closeDetailPage();
          }
        }
      });
    }

    function setupSearch() {
      const searchInput = document.getElementById('searchInput');
      let debounceTimer;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          searchQuery = e.target.value.trim();
          applyFilters();
        }, 300);
      });
    }

    // Canton code mapping for SVG highlighting (Wikipedia SVG uses canton codes directly)
    const cantonCodeMap = {
      'AG': 'AG', 'AI': 'AI', 'AR': 'AR', 'BE': 'BE', 'BL': 'BL',
      'BS': 'BS', 'FR': 'FR', 'GE': 'GE', 'GL': 'GL', 'GR': 'GR',
      'JU': 'JU', 'LU': 'LU', 'NE': 'NE', 'NW': 'NW', 'OW': 'OW',
      'SG': 'SG', 'SH': 'SH', 'SO': 'SO', 'SZ': 'SZ', 'TG': 'TG',
      'TI': 'TI', 'UR': 'UR', 'VD': 'VD', 'VS': 'VS', 'ZG': 'ZG', 'ZH': 'ZH'
    };

    // Convert lat/lng to SVG coordinates for Wikipedia SVG
    // SVG viewBox: 0 0 1052.361 744.094
    function latLngToSvg(lat, lng) {
      const minLat = 45.82, maxLat = 47.81;
      const minLng = 5.95, maxLng = 10.49;
      const svgWidth = 1052.361;
      const svgHeight = 744.094;
      const x = ((lng - minLng) / (maxLng - minLng)) * svgWidth;
      const y = ((maxLat - lat) / (maxLat - minLat)) * svgHeight;
      return { x, y };
    }

    let svgMapCache = null;

    async function loadSvgMap() {
      if (svgMapCache) return svgMapCache;
      try {
        const response = await fetch('switzerland.svg');
        svgMapCache = await response.text();
        return svgMapCache;
      } catch (e) {
        console.error('Error loading SVG map:', e);
        return null;
      }
    }

    function openDetailPage(id) {
      const prop = properties.find(p => p.id === id);
      if (!prop) return;

      // Update URL
      const params = new URLSearchParams(window.location.search);
      params.set('view', 'detail');
      params.set('id', id);
      window.history.pushState({ view: 'detail', id }, '', `?${params.toString()}`);

      renderDetailPage(prop);
    }

    async function renderDetailPage(prop) {
      // Set breadcrumb
      document.getElementById('detailBreadcrumb').textContent = `Alle Verkaufsobjekte / ${prop.year} / ${prop.econUnit} / ${prop.bldgNum}`;

      // Get multiple placeholder images for gallery
      const mainImage = getPlaceholderImage(prop.type, prop.id);
      const thumbImages = [
        getPlaceholderImage(prop.type, prop.id + '1'),
        getPlaceholderImage(prop.type, prop.id + '2'),
        getPlaceholderImage(prop.type, prop.id + '3'),
        getPlaceholderImage(prop.type, prop.id + '4')
      ];

      // All gallery images for carousel
      const allGalleryImages = [mainImage, ...thumbImages];

      // Load SVG map
      const svgMap = await loadSvgMap();
      const svgMapHtml = svgMap || '<div style="padding: 40px; text-align: center; color: #718096;">Karte nicht verfügbar</div>';

      // Render content
      document.getElementById('detailContent').innerHTML = `
        <div class="detail-hero">
          <!-- Gallery -->
          <div class="detail-gallery" id="detailGallery" data-images='${JSON.stringify(allGalleryImages)}'>
            <div class="detail-main-image clickable" style="background-image: url('${mainImage}')" data-image-index="0">
              <div class="image-tags">
                <span class="year-tag" data-filter="year" data-value="${prop.year}" data-detail="true">${prop.year}</span>
                <span class="priority-tag ${getPriorityClass(prop.priority)}" data-filter="priority" data-value="${getPriorityValue(prop.priority)}" data-detail="true">${getPriorityLabel(prop.priority, prop.priorityLabel)}</span>
              </div>
            </div>
            <div class="detail-thumb clickable" style="background-image: url('${thumbImages[0]}')" data-image-index="1"></div>
            <div class="detail-thumb clickable" style="background-image: url('${thumbImages[1]}')" data-image-index="2"></div>
            <div class="detail-thumb clickable" style="background-image: url('${thumbImages[2]}')" data-image-index="3"></div>
            <div class="detail-thumb clickable" style="background-image: url('${thumbImages[3]}')" data-image-index="4">
              <div class="detail-thumb-overlay">
                <span>Alle ${allGalleryImages.length} Bilder anzeigen.</span>
              </div>
            </div>
          </div>

          <!-- Info Sections -->
          <div class="detail-info">
            <!-- Title & Address -->
            <div class="detail-info-section detail-title-section">
              <h1>${prop.type} in ${prop.zip} ${prop.city}</h1>
              <div class="detail-data-label">${prop.address} ${prop.zip} ${prop.city}</div>
              <div class="detail-areas">
                <div class="detail-area">
                  <span class="material-icons-outlined detail-area-icon">square_foot</span>
                  <span class="detail-area-value">${prop.areaGF} m²</span>
                  <span class="detail-area-label">Geschossfläche</span>
                </div>
                <div class="detail-area">
                  <span class="material-icons-outlined detail-area-icon">landscape</span>
                  <span class="detail-area-value">${prop.areaGSF} m²</span>
                  <span class="detail-area-label">Grundstück</span>
                </div>
              </div>
            </div>

            <!-- Price -->
            <div class="detail-info-section detail-title-section">
              <h1>${formatPriceRange(prop.valueMin, prop.valueMax)}</h1>
              <div class="detail-data-label">${formatCHF(pricePerSqm(prop.valueMin, prop.areaGF))} - ${formatCHF(pricePerSqm(prop.valueMax, prop.areaGF))} / m² GF</div>
              <div class="detail-price-cards">
                <div class="detail-price-card">
                  <span class="detail-price-card-value">${formatCHF(prop.bookValue)}</span>
                  <span class="detail-price-card-label">Aktueller Buchwert</span>
                </div>
                <div class="detail-price-card">
                  <span class="detail-price-card-value">${formatCHF(prop.acquisitionValue)}</span>
                  <span class="detail-price-card-label">Anschaffungswert</span>
                </div>
              </div>
            </div>

            <!-- Status -->
            <div class="detail-info-section detail-title-section">
              <h1>${prop.milestone.current}/${prop.milestone.total} ${prop.milestone.label}</h1>
              <div class="detail-data-label">Meilenstein</div>
            </div>
          </div>
        </div>

        <!-- Tabs -->
        <div class="detail-tabs">
          <button class="detail-tab active" onclick="switchTab('ÜBERSICHT')">ÜBERSICHT</button>
          <button class="detail-tab disabled">MEILENSTEINE</button>
          <button class="detail-tab" onclick="switchTab('EREIGNISSE')">EREIGNISSE</button>
          <button class="detail-tab" onclick="switchTab('DOKUMENTE')">DOKUMENTE</button>
        </div>

        <!-- Tab Content -->
        <div class="detail-tab-content">
          <!-- ÜBERSICHT Tab -->
          <div class="tab-content-uebersicht active">
            <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: var(--neutral-900);">Identifikation Objekt</h2>
            <div class="detail-data-section">
              <div class="detail-data-column">
                <div class="detail-data-grid">
                  <div class="detail-data-item">
                    <div class="detail-data-value">${prop.techPlatz || '-'}</div>
                    <div class="detail-data-label">Technischer Platz Bund</div>
                  </div>
                  <div class="detail-data-item">
                    <div class="detail-data-value">Schweiz, ${prop.canton}</div>
                    <div class="detail-data-label">Land, Region (Kanton)</div>
                  </div>
                  <div class="detail-data-item">
                    <div class="detail-data-value">${prop.city}, ${prop.address}</div>
                    <div class="detail-data-label">Objekt Bezeichnung</div>
                  </div>
                  <div class="detail-data-item">
                    <div class="detail-data-value">${prop.address} ${prop.zip} ${prop.city}</div>
                    <div class="detail-data-label">Adresse</div>
                  </div>
                  <div class="detail-data-item">
                    <div class="detail-data-value">${prop.portfolio || '-'}</div>
                    <div class="detail-data-label">Teilportfolio Bund</div>
                  </div>
                  <div class="detail-data-item">
                    <div class="detail-data-value">${prop.type}</div>
                    <div class="detail-data-label">Objektart Verkauf</div>
                  </div>
                  <div class="detail-data-item">
                    <div class="detail-data-value">${prop.egid || '-'}</div>
                    <div class="detail-data-label">BFS EGID (nur Schweiz)</div>
                  </div>
                  <div class="detail-data-item">
                    <div class="detail-data-value">${prop.egrid || '-'}</div>
                    <div class="detail-data-label">BFS EGRID (nur Schweiz)</div>
                  </div>
                  <div class="detail-data-item">
                    <div class="detail-data-value">${prop.ownership || '-'}</div>
                    <div class="detail-data-label">Eigentum</div>
                  </div>
                  <div class="detail-data-item">
                    <div class="detail-data-value">${prop.buildYear || '-'}</div>
                    <div class="detail-data-label">Baujahr</div>
                  </div>
                </div>
                <div class="detail-links">
                  <a href="https://www.google.com/maps?q=${prop.lat},${prop.lng}" target="_blank" rel="noopener" class="detail-link">
                    <span class="material-icons-outlined">open_in_new</span>
                    Google Maps
                  </a>
                  <a href="https://map.geo.admin.ch/#/map?lang=de&swisssearch=${prop.lng},${prop.lat}&swisssearch_autoselect=true&z=12&topic=ech&layers=ch.swisstopo.amtliches-strassenverzeichnis;ch.bfs.gebaeude_wohnungs_register&bgLayer=ch.swisstopo.swissimage" target="_blank" rel="noopener" class="detail-link">
                    <span class="material-icons-outlined">open_in_new</span>
                    Gebäude- und Wohnungsregister
                  </a>
                  <a href="https://map.geo.admin.ch/#/map?lang=de&swisssearch=${prop.lng},${prop.lat}&swisssearch_autoselect=true&z=12&topic=ech&layers=ch.swisstopo-vd.stand-oerebkataster&bgLayer=ch.swisstopo.swissimage" target="_blank" rel="noopener" class="detail-link">
                    <span class="material-icons-outlined">open_in_new</span>
                    ÖREB-Kataster
                  </a>
                  <div class="detail-data-label">Verortung</div>
                </div>
              </div>

              <!-- Switzerland Map -->
              <div class="detail-map-container">
                <div class="detail-map-svg" id="detailMapSvg">${svgMapHtml}</div>
              </div>
            </div>

          <!-- Section Separator -->
          <div class="detail-section-separator"></div>

          <!-- Angaben zum Objekt -->
          <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: var(--neutral-900);">Angaben zum Objekt</h2>
          <div class="detail-object-section">
            <div class="detail-object-left">
              <div class="detail-data-item">
                <div class="detail-data-value">${prop.year || '-'}</div>
                <div class="detail-data-label">Jahr Verkauf</div>
              </div>
              <div class="detail-data-item">
                <div class="detail-data-value">${prop.areaGSF ? prop.areaGSF + ' m²' : '-'}</div>
                <div class="detail-data-label">Grundstücksfläche GSF</div>
              </div>
              <div class="detail-data-item">
                <div class="detail-data-value">${prop.ownership || '-'}</div>
                <div class="detail-data-label">Eigentum Art</div>
              </div>
              <div class="detail-data-item">
                <div class="detail-data-value">${prop.areaGF ? prop.areaGF + ' m²' : '-'}</div>
                <div class="detail-data-label">Geschossfläche GF</div>
              </div>
              <div class="detail-data-item">
                <div class="detail-data-value">${prop.buildYear || '-'}</div>
                <div class="detail-data-label">Baujahr</div>
              </div>
              <div class="detail-data-item">
                <div class="detail-data-value">${prop.floors || '-'}</div>
                <div class="detail-data-label">Anzahl Geschosse</div>
              </div>
              <div class="detail-data-item">
                <div class="detail-data-value">${prop.condition || '-'}</div>
                <div class="detail-data-label">Zustand</div>
              </div>
              <div class="detail-data-item">
                <div class="detail-data-value">${prop.livingArea ? prop.livingArea + ' m²' : 'Null'}</div>
                <div class="detail-data-label">Wohnfläche</div>
              </div>
              <div class="detail-data-item">
                <div class="detail-data-value">${prop.standard || '-'}</div>
                <div class="detail-data-label">Ausbaustandard</div>
              </div>
              <div class="detail-data-item">
                <div class="detail-data-value">${prop.apartments !== null ? prop.apartments : 'Null'}</div>
                <div class="detail-data-label">Anzahl Wohnungen</div>
              </div>
              <div class="detail-data-item">
                <div class="detail-data-value">${prop.isHeated !== null ? (prop.isHeated ? 'Ja' : 'Nein') : 'Null'}</div>
                <div class="detail-data-label">Objekt ist beheizt</div>
              </div>
              <div class="detail-data-item">
                <div class="detail-data-value">${prop.rooms !== null ? prop.rooms : 'Null'}</div>
                <div class="detail-data-label">Anzahl Zimmer</div>
              </div>
              <div class="detail-data-item">
                <div class="detail-data-value">${formatCHF(prop.bookValue)}</div>
                <div class="detail-data-label">Aktueller Buchwert</div>
              </div>
              <div class="detail-data-item">
                <div class="detail-data-value">${prop.parkingSpaces !== null ? prop.parkingSpaces : 'Null'}</div>
                <div class="detail-data-label">Anzahl Parkplätze</div>
              </div>
              <div class="detail-data-item">
                <div class="detail-data-value">${formatCHF(prop.acquisitionValue)}</div>
                <div class="detail-data-label">Anschaffungswert</div>
              </div>
              <div class="detail-data-item">
                <div class="detail-data-value">&nbsp;</div>
                <div class="detail-data-label">&nbsp;</div>
              </div>
              <div class="detail-data-item">
                <div class="detail-data-value">${prop.hasBuildingRights !== null ? (prop.hasBuildingRights ? 'Ja' : 'Nein') : 'Null'}</div>
                <div class="detail-data-label">Baurecht vorhanden?</div>
              </div>
              <div class="detail-data-item">
                <div class="detail-data-value">&nbsp;</div>
                <div class="detail-data-label">&nbsp;</div>
              </div>
              <div class="detail-data-item">
                <div class="detail-data-value">${prop.buildingRightsFee !== null ? 'CHF ' + formatNumber(prop.buildingRightsFee) : 'CHF Null'}</div>
                <div class="detail-data-label">Baurechtszins</div>
              </div>
            </div>
            <div class="detail-object-right">
              <div class="detail-geo-map">
                <iframe
                  src="https://map.geo.admin.ch/embed.html?lang=de&topic=ech&bgLayer=ch.swisstopo.swissimage&lon=${prop.lng}&lat=${prop.lat}&zoom=9&crosshair=marker"
                  allowfullscreen="true"
                  loading="lazy">
                </iframe>
              </div>
              <div class="detail-geo-info">
                <span class="detail-geo-coords">${formatCoord(prop.lat, 'N')} ${formatCoord(prop.lng, 'E')}</span>
                <span class="detail-geo-address">${prop.address} ${prop.city}</span>
              </div>
              <a href="https://www.google.com/maps/dir/?api=1&destination=${prop.lat},${prop.lng}" target="_blank" rel="noopener" class="detail-route-link">
                <span class="material-icons-outlined">directions</span>
                Routenplaner
              </a>
            </div>
          </div>

          <!-- Section Separator -->
          <div class="detail-section-separator"></div>

          <!-- Marktwert & Lage -->
          <div class="detail-value-location">
            <!-- Marktwert -->
            <div class="detail-value-section">
              <h2>Marktwert</h2>
              <div class="detail-value-chart">
                <div class="detail-value-main">${formatCHF(prop.valueMean)}</div>
                <div class="detail-value-bar-container">
                  <div class="detail-value-labels">
                    <span>${formatCHF(prop.valueMin)}</span>
                    <span>${formatCHF(prop.valueMax)}</span>
                  </div>
                  <div class="detail-value-bar">
                    ${prop.valueMax > prop.valueMin ?
                      '<div class="detail-value-marker" style="left: ' + (((prop.valueMean - prop.valueMin) / (prop.valueMax - prop.valueMin)) * 100) + '%"></div>'
                      : ''}
                  </div>
                  <div class="detail-value-scale">
                    <span>Minimum</span>
                    <span>Mittelwert</span>
                    <span>Maximum</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Lage -->
            <div class="detail-location-section">
              <h2>Lage</h2>
              <div class="detail-location-grid">
                <div class="detail-location-item">
                  <span class="detail-location-label">Gesamthaft</span>
                  <span class="detail-location-value">${prop.locationRatings ? prop.locationRatings.overall : 'Null'}</span>
                  <div class="detail-location-stars">
                    ${[1,2,3,4,5].map(i => '<span class="material-icons-outlined detail-location-star ' + (prop.locationRatings && i <= prop.locationRatings.overall ? 'filled' : '') + '">star</span>').join('')}
                  </div>
                </div>
                <div class="detail-location-item">
                  <span class="detail-location-label">Besonnung</span>
                  <span class="detail-location-value">${prop.locationRatings ? prop.locationRatings.sunExposure : 'Null'}</span>
                  <div class="detail-location-bar"><div class="detail-location-bar-fill" style="width: ${prop.locationRatings ? prop.locationRatings.sunExposure : 10}%"></div></div>
                </div>
                <div class="detail-location-item">
                  <span class="detail-location-label">Sicht</span>
                  <span class="detail-location-value">${prop.locationRatings ? prop.locationRatings.view : 'Null'}</span>
                  <div class="detail-location-bar"><div class="detail-location-bar-fill" style="width: ${prop.locationRatings ? prop.locationRatings.view : 10}%"></div></div>
                </div>
                <div class="detail-location-item">
                  <span class="detail-location-label">Image des Quartiers</span>
                  <span class="detail-location-value">${prop.locationRatings ? prop.locationRatings.neighborhoodImage : 'Null'}</span>
                  <div class="detail-location-bar"><div class="detail-location-bar-fill" style="width: ${prop.locationRatings ? prop.locationRatings.neighborhoodImage : 10}%"></div></div>
                </div>
                <div class="detail-location-item">
                  <span class="detail-location-label">Dienstleistungen</span>
                  <span class="detail-location-value">${prop.locationRatings ? prop.locationRatings.services : 'Null'}</span>
                  <div class="detail-location-bar"><div class="detail-location-bar-fill" style="width: ${prop.locationRatings ? prop.locationRatings.services : 10}%"></div></div>
                </div>
                <div class="detail-location-item">
                  <span class="detail-location-label">Freizeit & Erholung</span>
                  <span class="detail-location-value">${prop.locationRatings ? prop.locationRatings.leisureRecreation : 'Null'}</span>
                  <div class="detail-location-bar"><div class="detail-location-bar-fill" style="width: ${prop.locationRatings ? prop.locationRatings.leisureRecreation : 10}%"></div></div>
                </div>
                <div class="detail-location-item">
                  <span class="detail-location-label">Öffentlicher Verkehr</span>
                  <span class="detail-location-value">${prop.locationRatings ? prop.locationRatings.publicTransport : 'Null'}</span>
                  <div class="detail-location-bar"><div class="detail-location-bar-fill" style="width: ${prop.locationRatings ? prop.locationRatings.publicTransport : 10}%"></div></div>
                </div>
                <div class="detail-location-item">
                  <span class="detail-location-label">Strassenanbindung</span>
                  <span class="detail-location-value">${prop.locationRatings ? prop.locationRatings.roadConnection : 'Null'}</span>
                  <div class="detail-location-bar"><div class="detail-location-bar-fill" style="width: ${prop.locationRatings ? prop.locationRatings.roadConnection : 10}%"></div></div>
                </div>
                <div class="detail-location-item">
                  <span class="detail-location-label">Lärmbelastung</span>
                  <span class="detail-location-value">${prop.locationRatings ? prop.locationRatings.noisePollution : 'Null'}</span>
                  <div class="detail-location-bar"><div class="detail-location-bar-fill" style="width: ${prop.locationRatings ? prop.locationRatings.noisePollution : 10}%"></div></div>
                </div>
              </div>
            </div>
          </div>
          </div>

          <!-- EREIGNISSE Tab -->
          <div class="tab-content-ereignisse">
            <div class="tab-container">
              <div class="tab-header">
                <h2 class="tab-title">Ereignisse</h2>
              </div>
              <div class="tab-toolbar">
                <div class="tab-search">
                  <span class="material-icons-outlined">search</span>
                  <input type="text" id="eventSearchInput" placeholder="Alle Spalten filtern" onkeyup="filterEvents(this.value)">
                </div>
                <div class="tab-actions">
                  <button class="table-action-btn" id="eventDownloadBtn" onclick="downloadSelectedEvents()" title="CSV herunterladen">
                    <span class="material-icons-outlined">download</span>
                    <span>CSV herunterladen</span>
                  </button>
                </div>
              </div>
              <div id="eventsTableContainer">
                ${renderEventsTable(prop.events)}
              </div>
            </div>
          </div>

          <!-- DOKUMENTE Tab -->
          <div class="tab-content-dokumente">
            <div class="tab-container">
              <div class="tab-header">
                <h2 class="tab-title">Dokumente</h2>
              </div>
              <div class="tab-toolbar">
                <div class="tab-search">
                  <span class="material-icons-outlined">search</span>
                  <input type="text" id="documentSearchInput" placeholder="Alle Spalten filtern" onkeyup="filterDocuments(this.value)">
                </div>
                <div class="tab-actions">
                  <button class="table-action-btn" id="docDeleteBtn" onclick="deleteSelectedDocuments()" title="Löschen">
                    <span class="material-icons-outlined">delete</span>
                    <span>Löschen</span>
                  </button>
                  <button class="table-action-btn" id="docDownloadBtn" onclick="downloadSelectedDocuments()" title="Herunterladen">
                    <span class="material-icons-outlined">download</span>
                    <span>Herunterladen</span>
                  </button>
                  <button class="table-btn-outline" onclick="openUploadDialog()" title="Hinzufügen">
                    <span class="material-icons-outlined">add</span>
                    <span>Hinzufügen</span>
                  </button>
                </div>
              </div>
              <div id="documentsTableContainer">
                ${renderDocumentsTable(prop.documents)}
              </div>
            </div>
          </div>
        </div>
      `;

      // Show detail view
      document.body.classList.add('detail-active');
      document.getElementById('detailView').classList.add('active');

      // Store current property for document operations
      currentDocumentProperty = prop;

      // Highlight canton and position marker on map
      setTimeout(() => {
        highlightCantonOnMap(prop.canton, prop.lat, prop.lng);
      }, 100);
    }

    function highlightCantonOnMap(canton, lat, lng) {
      const svgContainer = document.getElementById('detailMapSvg');
      if (!svgContainer) return;

      const svg = svgContainer.querySelector('svg');
      if (!svg) return;

      // Remove previous highlights
      svg.querySelectorAll('path.highlighted').forEach(path => {
        path.classList.remove('highlighted');
      });

      // Highlight current canton
      const cantonId = cantonCodeMap[canton];
      if (cantonId) {
        const cantonPath = svg.getElementById(cantonId);
        if (cantonPath) {
          cantonPath.classList.add('highlighted');
        }
      }

      // Position or create marker
      if (lat && lng) {
        const pos = latLngToSvg(lat, lng);
        let marker = svg.getElementById('location-marker');

        if (!marker) {
          // Create marker if it doesn't exist
          marker = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          marker.setAttribute('id', 'location-marker');
          marker.setAttribute('r', '12');
          marker.setAttribute('fill', '#DC2626');
          marker.setAttribute('stroke', '#fff');
          marker.setAttribute('stroke-width', '3');
          svg.appendChild(marker);
        }

        marker.setAttribute('cx', pos.x);
        marker.setAttribute('cy', pos.y);
        marker.style.display = 'block';
      }
    }

    function closeDetailPage() {
      document.body.classList.remove('detail-active');
      document.getElementById('detailView').classList.remove('active');

      // Update URL back to list view
      const params = new URLSearchParams(window.location.search);
      params.delete('id');
      if (currentView !== 'gallery') {
        params.set('view', currentView);
      } else {
        params.delete('view');
      }
      const newUrl = params.toString() ? `?${params.toString()}` : window.location.pathname;
      window.history.pushState({ view: currentView }, '', newUrl);
    }

    function exportToPdf() {
      window.print();
    }

    // Document types for upload dialog
    const documentTypes = [
      '3D-Modelldaten',
      'Ansichtsplan',
      'Auszug ÖREB-Kataster',
      'Akte zu Unterhalt',
      'Grundrissplan',
      'Indikative Marktwertbewertung',
      'Kauf- Dienstbarkeitsvertrag',
      'Mieterdossier',
      'Mietvertrag',
      'Schliessplan / Sicherungsschein',
      'Serviceverträge',
      'Sonstiges'
    ];

    // Current property for document operations
    let currentDocumentProperty = null;

    // Tab switching functionality
    function switchTab(tabName) {
      // Update tab buttons
      const tabs = document.querySelectorAll('.detail-tab');
      tabs.forEach(tab => {
        if (tab.textContent === tabName) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });

      // Update tab content
      const uebersichtContent = document.querySelector('.tab-content-uebersicht');
      const ereignisseContent = document.querySelector('.tab-content-ereignisse');
      const dokumenteContent = document.querySelector('.tab-content-dokumente');

      // Hide all tabs first
      uebersichtContent.classList.remove('active');
      ereignisseContent.classList.remove('active');
      dokumenteContent.classList.remove('active');

      // Show the selected tab
      if (tabName === 'ÜBERSICHT') {
        uebersichtContent.classList.add('active');
      } else if (tabName === 'EREIGNISSE') {
        ereignisseContent.classList.add('active');
      } else if (tabName === 'DOKUMENTE') {
        dokumenteContent.classList.add('active');
      }
    }

    // Get file extension
    function getFileExtension(filename) {
      return filename.split('.').pop().toLowerCase();
    }

    // Get document icon based on file extension
    function getDocumentIcon(filename) {
      const ext = getFileExtension(filename);
      const iconMap = {
        'pdf': { icon: 'picture_as_pdf', class: 'pdf' },
        'xlsx': { icon: 'table_chart', class: 'xlsx' },
        'xls': { icon: 'table_chart', class: 'xls' },
        'png': { icon: 'image', class: 'png' },
        'jpg': { icon: 'image', class: 'jpg' },
        'jpeg': { icon: 'image', class: 'jpeg' },
        'gif': { icon: 'image', class: 'gif' },
        'glb': { icon: 'view_in_ar', class: 'glb' },
        'gltf': { icon: 'view_in_ar', class: 'gltf' },
        'obj': { icon: 'view_in_ar', class: 'obj' }
      };
      return iconMap[ext] || { icon: 'description', class: 'default' };
    }

    // Format document upload date with time
    function formatDocumentDate(isoDate) {
      const date = new Date(isoDate);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${day}.${month}.${year} ${hours}:${minutes}`;
    }

    // Format document date only (without time)
    function formatDocumentDateOnly(isoDate) {
      const date = new Date(isoDate);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}.${month}.${year}`;
    }

    // Render events table
    function renderEventsTable(events) {
      if (!events || events.length === 0) {
        return `
          <div class="tab-empty">
            <span class="material-icons-outlined">event_busy</span>
            <p>Keine Ereignisse vorhanden</p>
          </div>
        `;
      }

      const rows = events.map(event => {
        const dateOnly = formatDocumentDateOnly(event.timestamp);
        const comment = event.comment || '-';
        return `
          <tr data-event-id="${event.id}" class="event-row">
            <td class="data-table-checkbox">
              <input type="checkbox" aria-label="Ereignis auswählen" onchange="updateEventSelection()">
            </td>
            <td class="event-milestone">${event.milestone}</td>
            <td class="event-user">${event.user}</td>
            <td class="event-timestamp">${dateOnly}</td>
            <td class="event-comment">${comment}</td>
          </tr>
        `;
      }).join('');

      return `
        <table class="data-table">
          <thead>
            <tr>
              <th class="data-table-checkbox">
                <input type="checkbox" aria-label="Alle Ereignisse auswählen" onchange="toggleAllEvents(this)">
              </th>
              <th>Meilenstein</th>
              <th>Benutzer</th>
              <th>Zeitstempel</th>
              <th>Kommentar</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    // Toggle all event checkboxes
    function toggleAllEvents(headerCheckbox) {
      const checkboxes = document.querySelectorAll('.tab-content-ereignisse .data-table tbody input[type="checkbox"]');
      checkboxes.forEach(cb => {
        cb.checked = headerCheckbox.checked;
        cb.closest('tr').classList.toggle('selected', headerCheckbox.checked);
      });
      // Update action button state
      const downloadBtn = document.getElementById('eventDownloadBtn');
      if (downloadBtn) downloadBtn.classList.toggle('active', headerCheckbox.checked);
    }

    // Update event selection state
    function updateEventSelection() {
      const checkboxes = document.querySelectorAll('.tab-content-ereignisse .data-table tbody input[type="checkbox"]');
      const headerCheckbox = document.querySelector('.tab-content-ereignisse .data-table thead input[type="checkbox"]');
      const downloadBtn = document.getElementById('eventDownloadBtn');

      checkboxes.forEach(cb => {
        cb.closest('tr').classList.toggle('selected', cb.checked);
      });

      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      const someChecked = Array.from(checkboxes).some(cb => cb.checked);

      if (headerCheckbox) {
        headerCheckbox.checked = allChecked;
        headerCheckbox.indeterminate = someChecked && !allChecked;
      }

      // Toggle active state on action button
      if (downloadBtn) downloadBtn.classList.toggle('active', someChecked);
    }

    // Filter events by search term
    function filterEvents(searchTerm) {
      const rows = document.querySelectorAll('.tab-content-ereignisse .data-table tbody tr');
      const term = searchTerm.toLowerCase();

      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(term) ? '' : 'none';
      });
    }

    // Download selected events as CSV (placeholder)
    function downloadSelectedEvents() {
      const downloadBtn = document.getElementById('eventDownloadBtn');
      if (!downloadBtn || !downloadBtn.classList.contains('active')) return;

      const selected = document.querySelectorAll('.tab-content-ereignisse .data-table tbody input[type="checkbox"]:checked');
      if (selected.length === 0) return;

      const eventIds = Array.from(selected).map(cb => cb.closest('tr').dataset.eventId);
      alert(`CSV-Download von ${eventIds.length} Ereignis(sen) wird gestartet...\n\nIDs: ${eventIds.join(', ')}`);
    }

    // Render documents table
    function renderDocumentsTable(documents) {
      if (!documents || documents.length === 0) {
        return `
          <div class="tab-empty">
            <span class="material-icons-outlined">folder_open</span>
            <p>Keine Dokumente vorhanden</p>
          </div>
        `;
      }

      const rows = documents.map(doc => {
        const format = getFileExtension(doc.name).toUpperCase();
        const size = doc.size || '-';
        const dateOnly = formatDocumentDateOnly(doc.uploadedAt);
        const uploadedInfo = `${doc.uploadedBy}, ${dateOnly}`;
        return `
          <tr data-doc-id="${doc.id}" class="doc-row">
            <td class="data-table-checkbox">
              <input type="checkbox" aria-label="Dokument auswählen" onchange="updateDocumentSelection()">
            </td>
            <td class="doc-title"><a href="#" onclick="event.preventDefault()">${doc.title || doc.name}</a></td>
            <td class="doc-type">${doc.type}</td>
            <td class="doc-format">${format}</td>
            <td class="doc-uploaded">${uploadedInfo}</td>
            <td class="doc-size">${size}</td>
          </tr>
        `;
      }).join('');

      return `
        <table class="data-table">
          <thead>
            <tr>
              <th class="data-table-checkbox">
                <input type="checkbox" aria-label="Alle Dokumente auswählen" onchange="toggleAllDocuments(this)">
              </th>
              <th class="sortable" onclick="sortDocuments('title')">
                <span>Titel</span>
                <span class="material-icons-outlined sort-icon">unfold_more</span>
              </th>
              <th class="sortable" onclick="sortDocuments('type')">
                <span>Typ</span>
                <span class="material-icons-outlined sort-icon">unfold_more</span>
              </th>
              <th>Format</th>
              <th class="sortable" onclick="sortDocuments('uploaded')">
                <span>Hochgeladen</span>
                <span class="material-icons-outlined sort-icon">unfold_more</span>
              </th>
              <th>Grösse</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    // Toggle all document checkboxes
    function toggleAllDocuments(headerCheckbox) {
      const checkboxes = document.querySelectorAll('.tab-content-dokumente .data-table tbody input[type="checkbox"]');
      checkboxes.forEach(cb => {
        cb.checked = headerCheckbox.checked;
        cb.closest('tr').classList.toggle('selected', headerCheckbox.checked);
      });
      // Update action buttons state
      const deleteBtn = document.getElementById('docDeleteBtn');
      const downloadBtn = document.getElementById('docDownloadBtn');
      if (deleteBtn) deleteBtn.classList.toggle('active', headerCheckbox.checked);
      if (downloadBtn) downloadBtn.classList.toggle('active', headerCheckbox.checked);
    }

    // Update document selection state
    function updateDocumentSelection() {
      const checkboxes = document.querySelectorAll('.tab-content-dokumente .data-table tbody input[type="checkbox"]');
      const headerCheckbox = document.querySelector('.tab-content-dokumente .data-table thead input[type="checkbox"]');
      const deleteBtn = document.getElementById('docDeleteBtn');
      const downloadBtn = document.getElementById('docDownloadBtn');

      checkboxes.forEach(cb => {
        cb.closest('tr').classList.toggle('selected', cb.checked);
      });

      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      const someChecked = Array.from(checkboxes).some(cb => cb.checked);

      if (headerCheckbox) {
        headerCheckbox.checked = allChecked;
        headerCheckbox.indeterminate = someChecked && !allChecked;
      }

      // Toggle active state on action buttons
      if (deleteBtn) deleteBtn.classList.toggle('active', someChecked);
      if (downloadBtn) downloadBtn.classList.toggle('active', someChecked);
    }

    // Filter documents by search term
    function filterDocuments(searchTerm) {
      const rows = document.querySelectorAll('.tab-content-dokumente .data-table tbody tr');
      const term = searchTerm.toLowerCase();

      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(term) ? '' : 'none';
      });
    }

    // Sort documents by column
    let currentSortColumn = null;
    let currentSortDirection = 'asc';

    function sortDocuments(column) {
      const tbody = document.querySelector('.tab-content-dokumente .data-table tbody');
      if (!tbody) return;

      const rows = Array.from(tbody.querySelectorAll('tr'));

      // Toggle direction if same column
      if (currentSortColumn === column) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        currentSortColumn = column;
        currentSortDirection = 'asc';
      }

      const columnIndex = {
        'title': 1,
        'type': 2,
        'uploaded': 4
      }[column];

      rows.sort((a, b) => {
        const aVal = a.cells[columnIndex]?.textContent.trim() || '';
        const bVal = b.cells[columnIndex]?.textContent.trim() || '';

        let comparison = aVal.localeCompare(bVal, 'de');
        return currentSortDirection === 'desc' ? -comparison : comparison;
      });

      rows.forEach(row => tbody.appendChild(row));
    }

    // Delete selected documents
    function deleteSelectedDocuments() {
      const deleteBtn = document.getElementById('docDeleteBtn');
      if (!deleteBtn || !deleteBtn.classList.contains('active')) return;

      const selected = document.querySelectorAll('.tab-content-dokumente .data-table tbody input[type="checkbox"]:checked');
      if (selected.length === 0) return;

      if (confirm(`Möchten Sie ${selected.length} Dokument(e) wirklich löschen?`)) {
        selected.forEach(cb => {
          const row = cb.closest('tr');
          if (row) row.remove();
        });

        // Update header checkbox and action buttons
        const headerCheckbox = document.querySelector('.tab-content-dokumente .data-table thead input[type="checkbox"]');
        if (headerCheckbox) {
          headerCheckbox.checked = false;
          headerCheckbox.indeterminate = false;
        }
        updateDocumentSelection();
      }
    }

    // Download selected documents
    function downloadSelectedDocuments() {
      const downloadBtn = document.getElementById('docDownloadBtn');
      if (!downloadBtn || !downloadBtn.classList.contains('active')) return;

      const selected = document.querySelectorAll('.tab-content-dokumente .data-table tbody input[type="checkbox"]:checked');
      if (selected.length === 0) return;

      const docIds = Array.from(selected).map(cb => cb.closest('tr').dataset.docId);
      alert(`Download von ${docIds.length} Dokument(en) wird gestartet...\n\nIDs: ${docIds.join(', ')}`);
    }

    // Show document context menu (placeholder - could be extended)
    function showDocumentMenu(event, docId) {
      event.stopPropagation();
      // For now, just log the action - could be extended with a dropdown menu
      console.log('Document menu clicked for:', docId);
    }

    // Open upload dialog
    function openUploadDialog() {
      const overlay = document.getElementById('uploadDialogOverlay');
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden';

      // Reset form
      resetUploadForm();
    }

    // Close upload dialog
    function closeUploadDialog() {
      const overlay = document.getElementById('uploadDialogOverlay');
      overlay.classList.remove('active');
      document.body.style.overflow = '';
    }

    // Open login dialog
    function openLoginDialog() {
      const overlay = document.getElementById('loginDialogOverlay');
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden';

      // Clear form
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginPassword').value = '';
    }

    // Close login dialog
    function closeLoginDialog() {
      const overlay = document.getElementById('loginDialogOverlay');
      overlay.classList.remove('active');
      document.body.style.overflow = '';
    }

    // Submit login (mockup - just closes dialog)
    function submitLogin() {
      closeLoginDialog();
    }

    // Reset upload form
    function resetUploadForm() {
      const fileInput = document.getElementById('uploadFileInput');
      const dropzone = document.getElementById('uploadDropzone');
      const dropzoneText = document.getElementById('uploadDropzoneText');
      const typeSelect = document.getElementById('uploadTypeSelect');
      const nameInput = document.getElementById('uploadNameInput');
      const submitBtn = document.getElementById('uploadSubmitBtn');

      if (fileInput) fileInput.value = '';
      if (dropzone) dropzone.classList.remove('has-file');
      if (dropzoneText) dropzoneText.innerHTML = '<span class="upload-dropzone-text">Datei auswählen</span>';
      if (typeSelect) typeSelect.value = '';
      if (nameInput) nameInput.value = '';
      if (submitBtn) submitBtn.disabled = true;
    }

    // Handle file selection
    function handleFileSelect(file) {
      if (!file) return;

      const dropzone = document.getElementById('uploadDropzone');
      const dropzoneText = document.getElementById('uploadDropzoneText');
      const nameInput = document.getElementById('uploadNameInput');

      dropzone.classList.add('has-file');
      dropzoneText.innerHTML = `<span class="upload-dropzone-filename">${file.name}</span>`;
      nameInput.value = file.name;

      validateUploadForm();
    }

    // Validate upload form
    function validateUploadForm() {
      const dropzone = document.getElementById('uploadDropzone');
      const typeSelect = document.getElementById('uploadTypeSelect');
      const nameInput = document.getElementById('uploadNameInput');
      const submitBtn = document.getElementById('uploadSubmitBtn');

      const hasFile = dropzone.classList.contains('has-file');
      const hasType = typeSelect.value !== '';
      const hasName = nameInput.value.trim() !== '';

      submitBtn.disabled = !(hasFile && hasType && hasName);
    }

    // Submit document upload (simulated)
    function submitDocumentUpload() {
      const typeSelect = document.getElementById('uploadTypeSelect');
      const nameInput = document.getElementById('uploadNameInput');

      if (!currentDocumentProperty) return;

      // Create new document object
      const newDoc = {
        id: 'doc-' + Date.now(),
        name: nameInput.value.trim(),
        type: typeSelect.value,
        uploadedBy: 'user@example.com',
        uploadedAt: new Date().toISOString()
      };

      // Add to property documents (in memory only - would need backend for persistence)
      if (!currentDocumentProperty.documents) {
        currentDocumentProperty.documents = [];
      }
      currentDocumentProperty.documents.push(newDoc);

      // Re-render documents table
      const documentsTableContainer = document.getElementById('documentsTableContainer');
      if (documentsTableContainer) {
        documentsTableContainer.innerHTML = renderDocumentsTable(currentDocumentProperty.documents);
      }

      // Close dialog
      closeUploadDialog();
    }

    // Initialize drag and drop for upload dropzone
    function initUploadDropzone() {
      const dropzone = document.getElementById('uploadDropzone');
      if (!dropzone) return;

      dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
      });

      dropzone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
      });

      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect(files[0]);
        }
      });
    }

    // Initialize dropzone when DOM is ready
    document.addEventListener('DOMContentLoaded', initUploadDropzone);

    // Unified click handler (event delegation for tags, cards, rows, sidebar items)
    function handleContentClick(event) {
      // First, check if clicked on a filter tag
      const tag = event.target.closest('.priority-tag[data-filter], .year-tag[data-filter]');
      if (tag) {
        event.stopPropagation();
        event.preventDefault();

        const filterType = tag.dataset.filter;
        const filterValue = tag.dataset.value;
        const isDetailView = tag.dataset.detail === 'true';

        // Add the filter
        advancedFilters[filterType].add(filterValue);

        if (isDetailView) {
          // Close detail view and go back to main with filter applied
          closeDetailPage();
        }

        applyFilters();

        // Update filter modal if it's open
        if (document.getElementById('filterModalOverlay').classList.contains('active')) {
          renderFilterModal();
        }
        return;
      }

      // Check if clicked on a detail gallery image (main or thumbnail)
      const galleryImage = event.target.closest('.detail-main-image.clickable, .detail-thumb.clickable');
      if (galleryImage) {
        const gallery = document.getElementById('detailGallery');
        if (gallery) {
          const images = JSON.parse(gallery.dataset.images);
          const imageIndex = parseInt(galleryImage.dataset.imageIndex, 10);
          openCarousel(images, imageIndex);
        }
        return;
      }

      // Check if clicked on a gallery card
      const card = event.target.closest('.card[data-id]');
      if (card) {
        openDetailPage(card.dataset.id);
        return;
      }

      // Check if clicked on a list table row
      const row = event.target.closest('#listTableBody tr[data-id]');
      if (row) {
        openDetailPage(row.dataset.id);
        return;
      }

      // Check if clicked on a map sidebar item
      const sidebarItem = event.target.closest('.map-sidebar-item[data-id]');
      if (sidebarItem) {
        flyToProperty(sidebarItem.dataset.id);
        return;
      }
    }

    // Set up unified event delegation
    document.addEventListener('click', handleContentClick);

    // Handle browser back/forward navigation
    window.addEventListener('popstate', (event) => {
      const params = new URLSearchParams(window.location.search);
      const view = params.get('view');
      const id = params.get('id');

      if (view === 'detail' && id) {
        const prop = properties.find(p => p.id === id);
        if (prop) {
          renderDetailPage(prop);
        }
      } else {
        document.body.classList.remove('detail-active');
        document.getElementById('detailView').classList.remove('active');
        if (view && ['gallery', 'list', 'map'].includes(view)) {
          setView(view);
        }
      }
    });

    // --- INIT ---
    // Save original URL params BEFORE they get overwritten by setView() -> updateUrlParams()
    const initialParams = getUrlParams();

    setupFilterModal();
    setupSearch();
    setupViewToggle();
    loadFiltersFromUrl();
    setView(currentView);

    fetch('data.json')
      .then(res => res.json())
      .then(async data => {
        properties = data;
        filteredProperties = [...data];
        extractFilterOptions();
        applyFilters();

        // Check if detail view should be opened from URL (use saved params, not current URL)
        if (initialParams.view === 'detail' && initialParams.id) {
          const prop = properties.find(p => p.id === initialParams.id);
          if (prop) {
            await renderDetailPage(prop);
          }
        }
      })
      .catch(err => {
        console.error('Error loading data:', err);
        document.getElementById('objectGrid').innerHTML = `<div style="grid-column: 1/-1; padding: 20px; text-align: center; background: white;">Fehler beim Laden. Starte via Live Server.</div>`;
      });
  </script>
</body>
</html>
