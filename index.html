<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verkaufsplattform - Bundesamt für Bauten und Logistik</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet" />
  <style>
    /* --- Design Tokens (Modern Unified Color Scheme) --- */
    :root {
      /* Primary Palette - Brand Colors */
      --primary-900: #1A2332;
      --primary-700: #2D3748;
      --primary-500: #4A5568;
      --primary-100: #EDF2F7;

      /* Accent Palette - Unified Teal */
      --accent-600: #0077B6;
      --accent-500: #0096C7;
      --accent-100: #CAF0F8;

      /* Neutral Palette - Simplified Grays */
      --neutral-900: #1A202C;
      --neutral-700: #4A5568;
      --neutral-500: #718096;
      --neutral-300: #CBD5E0;
      --neutral-200: #E2E8F0;
      --neutral-100: #F7FAFC;
      --neutral-50: #FFFFFF;

      /* Priority Colors - Semantic */
      --priority-high-bg: #FEE2E2;
      --priority-high-text: #B91C1C;
      --priority-high-marker: #DC2626;

      --priority-normal-bg: #D1FAE5;
      --priority-normal-text: #047857;
      --priority-normal-marker: #10B981;

      --priority-low-bg: #DBEAFE;
      --priority-low-text: #1D4ED8;
      --priority-low-marker: #3B82F6;

      --priority-none-bg: #F3F4F6;
      --priority-none-text: #6B7280;
      --priority-none-marker: #9CA3AF;

      --priority-null-bg: #F9FAFB;
      --priority-null-text: #9CA3AF;
      --priority-null-border: #E5E7EB;
      --priority-null-marker: #D1D5DB;

      /* Interactive States */
      --state-hover-bg: #F7FAFC;
      --state-active-bg: var(--accent-600);
      --state-focus-ring: 0 0 0 3px rgba(0, 119, 182, 0.2);
      --state-disabled: #CBD5E0;

      /* Shadows */
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.12);
      --shadow-xl: 0 8px 32px rgba(0, 0, 0, 0.15);

      /* Overlays */
      --overlay-bg: rgba(0, 0, 0, 0.5);
    }

    /* --- Reset & Base --- */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { height: 100%; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background-color: var(--neutral-100); color: var(--neutral-900); line-height: 1.5;
      display: flex; flex-direction: column; min-height: 100%;
    }

    /* --- Header --- */
    .header {
      background-color: var(--primary-900); color: var(--neutral-50); padding: 0 24px;
      display: flex; align-items: center; justify-content: space-between;
      height: 64px; flex-shrink: 0;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .logo {
      width: 32px; height: 32px; background: var(--neutral-50); color: var(--primary-900);
      border-radius: 4px; display: flex; align-items: center; justify-content: center;
      font-size: 18px; font-weight: bold;
    }
    .header-title { display: flex; flex-direction: column; }
    .header-title-main { font-size: 14px; font-weight: 600; }
    .header-title-sub { font-size: 12px; opacity: 0.9; }
    .header-right { display: flex; gap: 16px; }
    .btn {
      padding: 8px 16px; border-radius: 4px; font-size: 14px; cursor: pointer; border: none;
      transition: background-color 0.2s;
    }
    .btn-primary { background-color: var(--accent-600); color: var(--neutral-50); }
    .btn-primary:hover { background-color: var(--accent-500); }
    .btn-outline { background-color: transparent; color: var(--neutral-50); border: 1px solid var(--neutral-50); }
    .btn-outline:hover { background-color: rgba(255,255,255,0.1); }

    /* --- Search & Filter --- */
    .search-section { background: var(--neutral-50); padding: 16px 0; flex-shrink: 0; }
    .search-section-inner { max-width: 1440px; margin: 0 auto; padding: 0 24px; }
    .search-row { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
    .search-input-wrapper { flex: 1; position: relative; }
    .search-input-wrapper .material-icons-outlined {
      position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
      color: var(--neutral-500); font-size: 20px;
    }
    .search-input {
      width: 100%; padding: 12px 16px 12px 44px;
      border: 1px solid var(--neutral-200); border-radius: 6px; font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .search-input:focus { outline: none; border-color: var(--accent-600); box-shadow: var(--state-focus-ring); }
    .view-toggle { display: flex; background: var(--neutral-100); border-radius: 6px; padding: 4px; }
    .view-toggle .material-icons-outlined { font-size: 20px; }
    .view-btn {
      padding: 8px 12px; border: none; background: transparent; cursor: pointer;
      border-radius: 4px; color: var(--neutral-500); display: flex; align-items: center; justify-content: center;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
    }
    .view-btn:hover { color: var(--neutral-900); }
    .view-btn.active { background: var(--accent-600); color: var(--neutral-50); box-shadow: var(--shadow-sm); }
    .view-btn-label { font-size: 13px; font-weight: 500; margin-left: 6px; }

    /* --- Filter Row & Priority Pills --- */
    .filter-row { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
    .filter-pills { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; flex: 1; }
    .filter-pill {
      padding: 8px 16px; border: 1px solid var(--neutral-200); border-radius: 20px;
      font-size: 13px; background: var(--neutral-50); color: var(--neutral-700); cursor: pointer;
      transition: all 0.2s; white-space: nowrap; display: inline-flex; align-items: center; gap: 6px;
    }
    .filter-pill:hover { border-color: var(--neutral-300); background: var(--neutral-100); }
    .filter-pill.active { background: var(--accent-600); border-color: var(--accent-600); color: var(--neutral-50); }
    .filter-pill .close-icon { display: none; font-size: 16px; margin-left: 2px; margin-right: -4px; }
    .filter-pill.active .close-icon { display: inline; }
    .reset-filters {
      display: none; align-items: center; justify-content: center; padding: 6px;
      border: none; background: transparent; color: var(--neutral-500); cursor: pointer;
      border-radius: 4px; transition: all 0.2s;
    }
    .reset-filters.visible { display: flex; }
    .reset-filters:hover { background: var(--neutral-100); color: var(--neutral-900); }
    .filter-right { display: flex; align-items: center; gap: 16px; }
    .stats-count { font-size: 14px; color: var(--neutral-700); font-weight: 600; }
    .filter-btn {
      display: flex; align-items: center; gap: 6px; padding: 8px 16px;
      border: 1px solid var(--neutral-200); border-radius: 20px; background: var(--neutral-50);
      font-size: 13px; color: var(--neutral-700); cursor: pointer; transition: all 0.2s;
    }
    .filter-btn .material-icons-outlined { font-size: 20px; }
    .filter-btn:hover { border-color: var(--accent-600); color: var(--accent-600); }
    .filter-btn.has-filters { border-color: var(--accent-600); color: var(--accent-600); background: var(--accent-100); }
    .filter-btn.panel-open { border-color: var(--accent-600); color: var(--neutral-50); background: var(--accent-600); }
    .filter-btn .filter-count {
      background: var(--accent-600); color: var(--neutral-50); font-size: 11px; font-weight: 600;
      padding: 2px 6px; border-radius: 10px; margin-left: 2px;
    }

    /* --- Filter Modal --- */
    .filter-modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: var(--overlay-bg); display: flex; align-items: flex-start; justify-content: center;
      padding: 80px 20px 40px; z-index: 1000; overflow-y: auto;
      opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
    }
    .filter-modal-overlay.active { opacity: 1; visibility: visible; }
    .filter-modal {
      background: var(--neutral-50); border-radius: 12px; width: 100%; max-width: 900px;
      box-shadow: var(--shadow-xl);
      transform: translateY(-20px); transition: transform 0.3s;
    }
    .filter-modal-overlay.active .filter-modal { transform: translateY(0); }
    .filter-modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 20px 24px; border-bottom: 1px solid var(--neutral-200);
    }
    .filter-modal-header h2 { font-size: 18px; font-weight: 600; color: var(--neutral-900); margin: 0; }
    .filter-modal-actions { display: flex; align-items: center; gap: 8px; }
    .filter-reset-btn, .filter-close-btn {
      width: 36px; height: 36px; border: none; background: var(--neutral-100);
      border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; color: var(--neutral-500);
    }
    .filter-reset-btn:hover, .filter-close-btn:hover { background: var(--neutral-200); color: var(--neutral-900); }
    .filter-modal-body { padding: 24px; }
    .filter-columns { display: grid; grid-template-columns: repeat(5, 1fr); gap: 24px; }
    .filter-column-title { font-size: 14px; font-weight: 600; color: var(--neutral-900); margin-bottom: 16px; }
    .filter-options { display: flex; flex-direction: column; gap: 8px; }
    .filter-option {
      padding: 10px 14px; border-radius: 6px; font-size: 13px;
      background: var(--neutral-100); color: var(--neutral-700); cursor: pointer; transition: all 0.2s;
      border: 1px solid transparent; display: flex; align-items: center; justify-content: space-between;
    }
    .filter-option:hover { background: var(--state-hover-bg); border-color: var(--neutral-200); }
    .filter-option.selected { background: var(--accent-600); color: var(--neutral-50); border-color: var(--accent-600); }
    .filter-option .close-icon { display: none; font-size: 16px; opacity: 0.7; }
    .filter-option.selected .close-icon { display: inline; }
    .filter-option.selected:hover .close-icon { opacity: 1; }

    @media (max-width: 900px) {
      .filter-columns { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 640px) {
      .filter-columns { grid-template-columns: repeat(2, 1fr); }
      .filter-modal { margin: 10px; max-width: calc(100% - 20px); }
    }

    /* --- Main Layout --- */
    .main {
      max-width: 1440px; margin: 0 auto; padding: 24px;
      flex: 1; display: flex; flex-direction: column; min-height: 0; width: 100%;
    }

    /* --- Gallery Grid --- */
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; }
    @media (max-width: 1200px) { .grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 900px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }

    /* --- Card Style --- */
    .card {
      background: var(--neutral-50); border-radius: 8px; overflow: hidden;
      box-shadow: var(--shadow-md); cursor: pointer;
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); }
    .card-image { position: relative; height: 180px; background-color: var(--neutral-200); background-size: cover; background-position: center; }
    /* Tag Style Shared */
    .priority-tag { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 500; box-shadow: var(--shadow-sm); }
    .priority-0 { background-color: var(--priority-high-bg); color: var(--priority-high-text); }
    .priority-1 { background-color: var(--priority-normal-bg); color: var(--priority-normal-text); }
    .priority-2 { background-color: var(--priority-low-bg); color: var(--priority-low-text); }
    .priority-3 { background-color: var(--priority-none-bg); color: var(--priority-none-text); }
    .priority-null { background-color: var(--priority-null-bg); color: var(--priority-null-text); border: 1px solid var(--priority-null-border); }

    .card-badge { position: absolute; top: 12px; left: 12px; }
    .card-content { padding: 16px; }
    .card-label { font-size: 15px; font-weight: 600; color: var(--neutral-900); margin-bottom: 4px; }
    .card-location { font-size: 13px; color: var(--neutral-700); margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--neutral-200); }
    .card-price { font-size: 15px; font-weight: 600; color: var(--neutral-900); margin-bottom: 2px; }
    .card-price-sqm { font-size: 12px; color: var(--neutral-500); margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--neutral-200); }
    .card-details { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 8px; font-size: 13px; margin-bottom: 16px; }
    .card-detail-label { color: var(--neutral-700); font-weight: 500; }
    .card-detail-value { color: var(--neutral-900); font-weight: 500; }
    .card-milestone { padding-top: 0px; }
    .milestone-bar { height: 6px; background: var(--neutral-200); border-radius: 3px; overflow: hidden; margin-bottom: 8px; }
    .milestone-progress { height: 100%; background: linear-gradient(90deg, var(--accent-600), var(--accent-500)); border-radius: 3px; transition: width 0.3s; }
    .milestone-text { font-size: 13px; color: var(--neutral-700); font-weight: 500; }

    /* --- List View --- */
    .view-container { display: none; }
    .view-container.active { display: block; }
    .stats-boxes { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px; }
    .stats-box { background: var(--neutral-50); border-radius: 8px; padding: 20px; text-align: center; box-shadow: var(--shadow-md); }
    .stats-box-value { font-size: 32px; font-weight: 600; color: var(--neutral-900); margin-bottom: 4px; }
    .stats-box-label { font-size: 13px; color: var(--neutral-500); }
    .stats-box-download { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s; }
    .stats-box-download:hover { background-color: var(--neutral-100); }
    .stats-box-download .material-icons-outlined { font-size: 32px; color: var(--neutral-500); margin-bottom: 4px; }
    .list-table-container { background: var(--neutral-50); border-radius: 8px; overflow: hidden; box-shadow: var(--shadow-md); }
    .list-table { width: 100%; border-collapse: collapse; }
    .list-table th { background: var(--neutral-100); padding: 14px 16px; text-align: left; font-size: 13px; font-weight: 600; color: var(--neutral-700); border-bottom: 1px solid var(--neutral-200); }
    .list-table td { padding: 14px 16px; font-size: 14px; color: var(--neutral-900); border-bottom: 1px solid var(--neutral-200); vertical-align: middle; }
    .list-table tbody tr:hover { background-color: var(--neutral-100); cursor: pointer; }
    .object-cell { display: flex; align-items: center; gap: 12px; }
    .object-icon { color: var(--neutral-500); font-size: 20px; }
    .milestone-text-small { font-size: 12px; color: var(--neutral-500); }

    /* --- MAP VIEW & SIDEBAR FIXES --- */
    .map-container {
        display: none; width: 100%;
        flex: 1; min-height: 0;
        background: var(--neutral-50); border-radius: 8px; overflow: hidden;
        box-shadow: var(--shadow-md);
    }
    .map-container.active { display: grid; grid-template-columns: 320px 1fr; grid-template-rows: 1fr; max-height: 1200px; }

    .map-sidebar {
        width: 100%; height: 100%;
        background: var(--neutral-50); overflow-y: auto;
        border-right: 1px solid var(--neutral-200);
        scrollbar-width: thin;
    }

    /* Sidebar Item Fixes */
    .map-sidebar-item {
        padding: 16px;
        border-bottom: 1px solid var(--neutral-200);
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        flex-direction: column; /* Stack: Image top, Text bottom */
        gap: 12px;
    }
    .map-sidebar-item:hover { background-color: var(--neutral-100); }
    .map-sidebar-item.active { background-color: var(--accent-100); padding-left: 12px; border-left: 3px solid var(--accent-600); } /* Highlight style */

    .map-sidebar-image {
        position: relative;
        width: 100%;
        height: 160px; /* Fixed Height für Bild */
        background-color: var(--neutral-200);
        background-size: cover;
        background-position: center;
        border-radius: 6px;
        overflow: hidden;
    }
    /* Tag im Bild oben links */
    .map-sidebar-image .priority-tag {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 2;
    }

    .map-sidebar-content { display: flex; flex-direction: column; gap: 4px; }
    .map-sidebar-title { font-size: 15px; font-weight: 600; color: var(--neutral-900); line-height: 1.3; }
    .map-sidebar-price { font-size: 14px; font-weight: 600; color: var(--accent-600); margin-top: 4px; }

    .map-area { position: relative; width: 100%; height: 100%; background-color: var(--neutral-200); overflow: hidden; }
    #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; }

    /* Map Markers */
    .marker {
        width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3); border: 2px solid var(--neutral-50);
    }
    .marker-0 { background-color: var(--priority-high-marker); }
    .marker-1 { background-color: var(--priority-normal-marker); }
    .marker-2 { background-color: var(--priority-low-marker); }
    .marker-3 { background-color: var(--priority-none-marker); }
    .marker-null { background-color: var(--priority-null-marker); }
    .marker .material-icons { color: var(--neutral-50); font-size: 16px; }
    .marker.selected { border: 3px solid var(--accent-600); transform: scale(1.15); z-index: 10; }

    .mapboxgl-popup-content { padding: 0; border-radius: 8px; overflow: hidden; min-width: 250px; }
    .popup-image { height: 120px; background-size: cover; background-position: center; }
    .popup-content { padding: 12px; }
    .popup-title { font-weight: 600; margin-bottom: 4px; }
    .popup-link { display: block; text-align: center; padding: 8px 12px; background: var(--primary-900); color: var(--neutral-50); text-decoration: none; border-radius: 4px; margin-top: 8px; cursor: pointer; }

    /* --- Modal --- */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: var(--overlay-bg); display: flex; align-items: flex-start; justify-content: center;
      padding: 40px 20px; z-index: 1000; overflow-y: auto; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal { background: var(--neutral-50); border-radius: 8px; width: 100%; max-width: 1000px; transform: translateY(20px); transition: transform 0.3s; }
    .modal-overlay.active .modal { transform: translateY(0); }
    .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; border-bottom: 1px solid var(--neutral-200); background: var(--neutral-100); border-radius: 8px 8px 0 0; }
    .modal-back { display: flex; align-items: center; gap: 8px; background: var(--neutral-50); border: 1px solid var(--neutral-200); padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; color: var(--neutral-900); }
    .modal-back:hover { background: var(--neutral-100); }
    .modal-body { padding: 24px; }

    /* Detail Styles omitted for brevity but present in logic */
    .detail-top { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px; }
    .detail-image { height: 300px; background: var(--neutral-200); border-radius: 8px; background-size: cover; background-position: center; }
    .detail-summary { display: flex; flex-direction: column; gap: 16px; }
    .detail-title { font-size: 24px; font-weight: 600; color: var(--neutral-900); }
    .detail-section-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; color: var(--neutral-900); }
    .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    .detail-item { padding: 12px 0; border-bottom: 1px solid var(--neutral-200); }
    .detail-item-label { font-size: 12px; color: var(--neutral-500); }
    .detail-item-value { font-size: 14px; font-weight: 500; }

    /* Responsive */
    @media (max-width: 900px) { .stats-boxes { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 768px) {
        .detail-top { grid-template-columns: 1fr; }
        .map-container.active { display: flex; flex-direction: column; height: auto; }
        .map-sidebar { width: 100%; max-height: 250px; border-right: none; border-bottom: 1px solid var(--neutral-200); }
        .map-area { height: 400px; width: 100%; }
        .map-sidebar-image { height: 120px; } /* Kleineres Bild auf Mobile */
    }
    @media (max-width: 640px) {
        .header { padding: 12px 16px; height: auto; flex-wrap: wrap; gap: 12px; }
        .search-row, .filter-row { flex-direction: column; align-items: stretch; }
        .grid { grid-template-columns: 1fr; }
    }

    /* --- Footer --- */
    .footer {
      background-color: var(--primary-900);
      color: var(--neutral-50);
      padding: 4px 24px;
      display: flex;
      align-items: center;
      justify-content: left;
      gap: 32px;
      flex-shrink: 0;
    }
    .footer-link {
      color: var(--neutral-50);
      text-decoration: none;
      font-size: 14px;
      transition: opacity 0.2s;
    }
    .footer-link:hover {
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <div class="logo">C</div>
      <div class="header-title">
        <span class="header-title-main">Verkaufsplattform</span>
        <span class="header-title-sub">Bundesamt für Bauten und Logistik</span>
      </div>
    </div>
    <div class="header-right">
      <button class="btn btn-primary">Auftrag erstellen</button>
      <button class="btn btn-outline">Login</button>
    </div>
  </header>

  <div class="search-section">
    <div class="search-section-inner">
      <div class="search-row">
        <div class="search-input-wrapper">
          <span class="material-icons-outlined">search</span>
          <input type="text" class="search-input" id="searchInput" placeholder="Suche nach Bezeichnung, Adresse, oder Wirtschaftseinheit">
        </div>
        <div class="view-toggle">
          <button class="view-btn" data-view="map" title="Karte"><span class="material-icons-outlined">map</span></button>
          <button class="view-btn" data-view="list" title="Liste"><span class="material-icons-outlined">reorder</span><span class="view-btn-label">Liste</span></button>
          <button class="view-btn active" data-view="gallery" title="Galerie"><span class="material-icons-outlined">grid_view</span></button>
        </div>
      </div>
      <div class="filter-row">
        <div class="filter-pills" id="filterPills"></div>
        <div class="filter-right">
          <div class="stats-count"><span id="objectCount">0</span> Objekte</div>
          <button class="filter-btn" id="filterBtn">
            <span>Filter</span>
            <span class="filter-count" id="filterCount" style="display: none;">0</span>
            <span class="material-icons-outlined">tune</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <main class="main">
    <div class="view-container active" id="galleryView">
      <div class="grid" id="objectGrid"></div>
    </div>

    <div class="view-container" id="listView">
      <div class="stats-boxes" id="statsBoxes">
        <div class="stats-box"><div class="stats-box-value" id="statsTotalObjects">0</div><div class="stats-box-label">Anzahl Objekte</div></div>
        <div class="stats-box"><div class="stats-box-value" id="statsHighPriority">0</div><div class="stats-box-label">Hohe Priorität</div></div>
        <div class="stats-box"><div class="stats-box-value" id="statsNormalPriority">0</div><div class="stats-box-label">Normale Priorität</div></div>
        <div class="stats-box"><div class="stats-box-value" id="statsLowPriority">0</div><div class="stats-box-label">Geringe Priorität</div></div>
        <div class="stats-box stats-box-download" onclick="exportToExcel()"><span class="material-icons-outlined">download</span><div class="stats-box-label">Excel Download</div></div>
      </div>
      <div class="list-table-container">
        <table class="list-table">
          <thead><tr><th></th><th>ID</th><th>Objekt</th><th>Verkaufsjahr</th><th>Priorisierung</th><th>Meilenstein</th><th>Objekt Fläche</th><th>Marktwert</th></tr></thead>
          <tbody id="listTableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="map-container" id="mapView">
      <div class="map-sidebar" id="mapSidebar"></div>
      <div class="map-area">
        <div id="map"></div>
      </div>
    </div>
  </main>

  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <button class="modal-back" onclick="closeModal()">← Zurück zur Übersicht</button>
        <span class="modal-breadcrumb" id="modalBreadcrumb"></span>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <!-- Filter Modal -->
  <div class="filter-modal-overlay" id="filterModalOverlay">
    <div class="filter-modal">
      <div class="filter-modal-header">
        <h2>Suchfilter</h2>
        <div class="filter-modal-actions">
          <button class="filter-reset-btn" id="filterResetBtn" title="Filter zurücksetzen">
            <span class="material-icons-outlined">refresh</span>
          </button>
          <button class="filter-close-btn" id="filterCloseBtn">
            <span class="material-icons-outlined">close</span>
          </button>
        </div>
      </div>
      <div class="filter-modal-body">
        <div class="filter-columns">
          <div class="filter-column">
            <h3 class="filter-column-title">Nutzung</h3>
            <div class="filter-options" id="filterNutzung"></div>
          </div>
          <div class="filter-column">
            <h3 class="filter-column-title">Verkaufsjahr</h3>
            <div class="filter-options" id="filterYear"></div>
          </div>
          <div class="filter-column">
            <h3 class="filter-column-title">Priorisierung</h3>
            <div class="filter-options" id="filterPriority"></div>
          </div>
          <div class="filter-column">
            <h3 class="filter-column-title">Meilenstein</h3>
            <div class="filter-options" id="filterMilestone"></div>
          </div>
          <div class="filter-column">
            <h3 class="filter-column-title">Portfolio</h3>
            <div class="filter-options" id="filterPortfolio"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <a href="https://github.com/davras5/transaction-immo" class="footer-link" target="_blank" rel="noopener noreferrer">Quellcode</a>
    <a href="https://www.admin.ch/gov/de/start/rechtliches.html" class="footer-link" target="_blank" rel="noopener noreferrer">Rechtliches</a>
  </footer>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiZGF2aWRyYXNuZXI1IiwiYSI6ImNtMm5yamVkdjA5MDcycXMyZ2I2MHRhamgifQ.m651j7WIX7MyxNh8KIQ1Gg';

    let properties = [];
    let filteredProperties = [];
    let searchQuery = '';
    let currentView = 'gallery';
    let map = null;
    let mapLoaded = false;
    let markers = [];
    let markersMap = new Map();

    // Advanced filter state
    let advancedFilters = {
      type: new Set(),        // Nutzung
      year: new Set(),        // Verkaufsjahr
      priority: new Set(),    // Priorisierung
      milestone: new Set(),   // Meilenstein
      portfolio: new Set()    // Portfolio
    };

    // Unique values from data (populated after load)
    let filterOptions = {
      type: [],
      year: [],
      priority: [],
      milestone: [],
      portfolio: []
    };

    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        view: params.get('view'),
        q: params.get('q'),
        type: params.get('type'),
        year: params.get('year'),
        priority: params.get('priority'),
        milestone: params.get('milestone'),
        portfolio: params.get('portfolio')
      };
    }

    function updateUrlParams() {
      const params = new URLSearchParams();
      if (currentView !== 'gallery') params.set('view', currentView);
      if (searchQuery) params.set('q', searchQuery);

      // Add all advanced filters
      Object.keys(advancedFilters).forEach(key => {
        if (advancedFilters[key].size > 0) {
          params.set(key, Array.from(advancedFilters[key]).join(','));
        }
      });

      const newUrl = params.toString() ? `${window.location.pathname}?${params.toString()}` : window.location.pathname;
      window.history.replaceState({}, '', newUrl);
    }

    function loadFiltersFromUrl() {
      const params = getUrlParams();
      if (params.view && ['gallery', 'list', 'map'].includes(params.view)) currentView = params.view;
      if (params.q) {
        searchQuery = params.q;
        document.getElementById('searchInput').value = searchQuery;
      }

      // Load all advanced filters from URL
      ['type', 'year', 'priority', 'milestone', 'portfolio'].forEach(key => {
        if (params[key]) {
          params[key].split(',').forEach(val => advancedFilters[key].add(val));
        }
      });
    }

    function getPriorityClass(priority) { return (priority === null || priority === undefined) ? 'priority-null' : `priority-${priority}`; }
    function getPriorityLabel(priority, priorityLabel) { return (priority === null || priority === undefined) ? 'Keine Angabe' : priorityLabel; }
    function formatCHF(value) { return (!value) ? 'CHF 0' : 'CHF ' + value.toLocaleString('de-CH').replace(/,/g, "'"); }
    function formatPriceRange(min, max) { return ((!min) && (!max)) ? 'CHF 0 - CHF 0' : formatCHF(min) + ' - ' + formatCHF(max); }
    function pricePerSqm(price, area) { return (!price || !area) ? 0 : Math.round(price / area); }

    function getPlaceholderImage(type, id) {
      const hash = id.split('').reduce((a, b) => { a = ((a << 5) - a) + b.charCodeAt(0); return a & a; }, 0);
      const imageIndex = Math.abs(hash) % 5;
      const images = ['https://images.unsplash.com/photo-1568605114967-8130f3a36994', 'https://images.unsplash.com/photo-1570129477492-45c003edd2be', 'https://images.unsplash.com/photo-1564013799919-ab600027ffc6', 'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab', 'https://images.unsplash.com/photo-1581094794329-c8112a89af12'];
      return images[imageIndex] + '?w=400&h=300&fit=crop';
    }

    // Extract unique filter options from data
    function extractFilterOptions() {
      const types = new Set();
      const years = new Set();
      const priorities = new Map(); // value -> label
      const milestones = new Map(); // current/total -> label
      const portfolios = new Set();

      properties.forEach(prop => {
        if (prop.type) types.add(prop.type);
        if (prop.year) years.add(prop.year);

        const pKey = prop.priority !== null && prop.priority !== undefined ? String(prop.priority) : 'null';
        const pLabel = getPriorityLabel(prop.priority, prop.priorityLabel);
        priorities.set(pKey, pLabel);

        if (prop.milestone) {
          const mKey = `${prop.milestone.current}/${prop.milestone.total}`;
          milestones.set(mKey, prop.milestone.label);
        }

        if (prop.portfolio) portfolios.add(prop.portfolio);
      });

      filterOptions.type = Array.from(types).sort();
      filterOptions.year = Array.from(years).sort((a, b) => a - b);
      filterOptions.priority = Array.from(priorities.entries()).map(([value, label]) => ({ value, label }));
      filterOptions.milestone = Array.from(milestones.entries()).map(([value, label]) => ({ value, label }));
      filterOptions.portfolio = Array.from(portfolios).sort();
    }

    // Check if any filters are active
    function hasActiveFilters() {
      return Object.values(advancedFilters).some(set => set.size > 0) || searchQuery;
    }

    // Count total active filters (excluding search)
    function getActiveFilterCount() {
      let count = 0;
      Object.values(advancedFilters).forEach(set => count += set.size);
      return count;
    }

    // Get priority counts from all properties
    function getPriorityCounts() {
      const counts = { '0': 0, '1': 0, '2': 0, '3': 0, 'null': 0 };
      properties.forEach(prop => {
        const pKey = prop.priority !== null && prop.priority !== undefined ? String(prop.priority) : 'null';
        if (counts.hasOwnProperty(pKey)) counts[pKey]++;
      });
      return counts;
    }

    // Update the filter button appearance and count
    function updateFilterButtonState() {
      const btn = document.getElementById('filterBtn');
      const countEl = document.getElementById('filterCount');
      const count = getActiveFilterCount();

      if (count > 0) {
        btn.classList.add('has-filters');
        countEl.textContent = count;
        countEl.style.display = 'inline';
      } else {
        btn.classList.remove('has-filters');
        countEl.style.display = 'none';
      }
    }

    // Render priority pills and reset button
    function renderPriorityPills() {
      const container = document.getElementById('filterPills');
      const counts = getPriorityCounts();

      // Priority labels mapping
      const priorityLabels = {
        '0': 'Hohe Priorität',
        '1': 'Normale Priorität',
        '2': 'Geringe Priorität',
        '3': 'Keine Priorität',
        'null': 'Keine Angabe'
      };

      // Build pills HTML
      let html = ['0', '1', '2', '3', 'null'].map(pKey => {
        const isActive = advancedFilters.priority.has(pKey);
        return `
          <button class="filter-pill ${isActive ? 'active' : ''}" data-priority="${pKey}">
            ${priorityLabels[pKey]} (${counts[pKey]})
            <span class="material-icons-outlined close-icon">close</span>
          </button>
        `;
      }).join('');

      // Add reset button
      html += `
        <button class="reset-filters ${hasActiveFilters() ? 'visible' : ''}" id="resetFilters" title="Alle Filter zurücksetzen">
          <span class="material-icons-outlined">replay</span>
        </button>
      `;

      container.innerHTML = html;

      // Add click handlers for priority pills
      container.querySelectorAll('.filter-pill').forEach(pill => {
        pill.addEventListener('click', () => {
          const priority = pill.dataset.priority;
          if (advancedFilters.priority.has(priority)) {
            advancedFilters.priority.delete(priority);
          } else {
            advancedFilters.priority.add(priority);
          }
          applyFilters();
          renderFilterModal();
        });
      });

      // Add click handler for reset button
      const resetBtn = container.querySelector('#resetFilters');
      if (resetBtn) {
        resetBtn.addEventListener('click', resetAllFilters);
      }
    }

    // Reset all filters
    function resetAllFilters() {
      Object.keys(advancedFilters).forEach(key => advancedFilters[key].clear());
      searchQuery = '';
      document.getElementById('searchInput').value = '';
      applyFilters();
      if (document.getElementById('filterModalOverlay').classList.contains('active')) {
        renderFilterModal();
      }
    }

    // Apply all filters
    function applyFilters() {
      filteredProperties = properties.filter(prop => {
        // Search query filter
        if (searchQuery) {
          const query = searchQuery.toLowerCase();
          const searchFields = [prop.id, prop.title, prop.type, prop.city, prop.zip, prop.address, prop.canton].map(f => (f || '').toLowerCase());
          if (!searchFields.some(field => field.includes(query))) return false;
        }

        // Type filter (OR within category)
        if (advancedFilters.type.size > 0 && !advancedFilters.type.has(prop.type)) {
          return false;
        }

        // Year filter (OR within category)
        if (advancedFilters.year.size > 0 && !advancedFilters.year.has(String(prop.year))) {
          return false;
        }

        // Priority filter (OR within category)
        if (advancedFilters.priority.size > 0) {
          const pKey = prop.priority !== null && prop.priority !== undefined ? String(prop.priority) : 'null';
          if (!advancedFilters.priority.has(pKey)) return false;
        }

        // Milestone filter (OR within category)
        if (advancedFilters.milestone.size > 0) {
          const mKey = prop.milestone ? `${prop.milestone.current}/${prop.milestone.total}` : '';
          if (!advancedFilters.milestone.has(mKey)) return false;
        }

        // Portfolio filter (OR within category)
        if (advancedFilters.portfolio.size > 0 && !advancedFilters.portfolio.has(prop.portfolio)) {
          return false;
        }

        return true;
      });

      if (currentView === 'gallery') renderCards();
      else if (currentView === 'list') renderListView();
      else if (currentView === 'map') renderMapView();

      updateUrlParams();
      updateFilterButtonState();
      renderPriorityPills();
    }

    // Render filter modal options
    function renderFilterModal() {
      // Helper to create option HTML with close icon
      const createOption = (isSelected, filterKey, value, label) => `
        <div class="filter-option ${isSelected ? 'selected' : ''}" data-filter="${filterKey}" data-value="${value}">
          <span>${label}</span>
          <span class="material-icons-outlined close-icon">close</span>
        </div>
      `;

      // Nutzung (type)
      const typeContainer = document.getElementById('filterNutzung');
      typeContainer.innerHTML = filterOptions.type.map(t =>
        createOption(advancedFilters.type.has(t), 'type', t, t)
      ).join('');

      // Verkaufsjahr (year)
      const yearContainer = document.getElementById('filterYear');
      yearContainer.innerHTML = filterOptions.year.map(y =>
        createOption(advancedFilters.year.has(String(y)), 'year', y, y)
      ).join('');

      // Priorisierung (priority) - show all 5 options
      const priorityContainer = document.getElementById('filterPriority');
      const priorityLabels = {
        '0': 'Hohe Priorität',
        '1': 'Normale Priorität',
        '2': 'Geringe Priorität',
        '3': 'Keine Priorität',
        'null': 'Keine Angabe'
      };
      priorityContainer.innerHTML = ['0', '1', '2', '3', 'null'].map(pKey =>
        createOption(advancedFilters.priority.has(pKey), 'priority', pKey, priorityLabels[pKey])
      ).join('');

      // Meilenstein (milestone)
      const milestoneContainer = document.getElementById('filterMilestone');
      milestoneContainer.innerHTML = filterOptions.milestone.map(m =>
        createOption(advancedFilters.milestone.has(m.value), 'milestone', m.value, `${m.value} ${m.label}`)
      ).join('');

      // Portfolio
      const portfolioContainer = document.getElementById('filterPortfolio');
      portfolioContainer.innerHTML = filterOptions.portfolio.map(p =>
        createOption(advancedFilters.portfolio.has(p), 'portfolio', p, p)
      ).join('');

      // Add click handlers
      document.querySelectorAll('.filter-modal .filter-option').forEach(opt => {
        opt.addEventListener('click', () => {
          const filterKey = opt.dataset.filter;
          const filterValue = opt.dataset.value;

          if (advancedFilters[filterKey].has(filterValue)) {
            advancedFilters[filterKey].delete(filterValue);
            opt.classList.remove('selected');
          } else {
            advancedFilters[filterKey].add(filterValue);
            opt.classList.add('selected');
          }

          applyFilters();
          // Update close icons visibility
          renderFilterModal();
        });
      });
    }

    // Filter Modal open/close
    function openFilterModal() {
      renderFilterModal();
      document.getElementById('filterModalOverlay').classList.add('active');
      document.getElementById('filterBtn').classList.add('panel-open');
      document.body.style.overflow = 'hidden';
    }

    function closeFilterModal() {
      document.getElementById('filterModalOverlay').classList.remove('active');
      document.getElementById('filterBtn').classList.remove('panel-open');
      document.body.style.overflow = '';
    }

    function getDataToRender() { return (filteredProperties.length > 0 || hasActiveFilters()) ? filteredProperties : properties; }

    function renderCards() {
      const grid = document.getElementById('objectGrid');
      const data = getDataToRender();
      document.getElementById('objectCount').textContent = data.length;
      grid.innerHTML = data.map(prop => `
        <div class="card" onclick="openModal('${prop.id}')">
          <div class="card-image" style="background-image: url('${getPlaceholderImage(prop.type, prop.id)}')">
            <span class="card-badge priority-tag ${getPriorityClass(prop.priority)}">${getPriorityLabel(prop.priority, prop.priorityLabel)}</span>
          </div>
          <div class="card-content">
            <div class="card-label">${prop.id} ${prop.type}</div>
            <div class="card-location">In ${prop.zip} ${prop.city}</div>
            <div class="card-price">${formatPriceRange(prop.valueMin, prop.valueMax)}</div>
            <div class="card-price-sqm">CHF ${pricePerSqm(prop.valueMin, prop.areaGF)} - CHF ${pricePerSqm(prop.valueMax, prop.areaGF)} / m² GF</div>
            <div class="card-details">
              <span class="card-detail-label">Verkaufsjahr:</span><span class="card-detail-value">${prop.year}</span>
              <span class="card-detail-label">Geschossfläche GF:</span><span class="card-detail-value">${prop.areaGF} m²</span>
              <span class="card-detail-label">Buchwert:</span><span class="card-detail-value">${formatCHF(prop.bookValue)}</span>
            </div>
            <div class="card-milestone">
              <div class="milestone-bar"><div class="milestone-progress" style="width: ${(prop.milestone.current / prop.milestone.total) * 100}%"></div></div>
              <div class="milestone-text">Meilenstein ${prop.milestone.current}/${prop.milestone.total} ${prop.milestone.label}</div>
            </div>
          </div>
        </div>`).join('');
    }

    function renderListView() {
      const data = getDataToRender();
      document.getElementById('objectCount').textContent = data.length;
      const stats = { total: data.length, high: 0, normal: 0, low: 0 };
      data.forEach(p => {
        if (p.priorityLabel === 'Hohe Priorität') stats.high++;
        else if (p.priorityLabel === 'Normale Priorität') stats.normal++;
        else if (p.priorityLabel === 'Geringe Priorität') stats.low++;
      });
      document.getElementById('statsTotalObjects').textContent = stats.total;
      document.getElementById('statsHighPriority').textContent = stats.high;
      document.getElementById('statsNormalPriority').textContent = stats.normal;
      document.getElementById('statsLowPriority').textContent = stats.low;

      const tbody = document.getElementById('listTableBody');
      tbody.innerHTML = data.map(prop => `
        <tr onclick="openModal('${prop.id}')">
          <td><span class="material-icons-outlined object-icon">home</span></td>
          <td>${prop.id}</td>
          <td>${prop.type} in ${prop.zip} ${prop.city}</td>
          <td>${prop.year}</td>
          <td><span class="priority-tag ${getPriorityClass(prop.priority)}">${getPriorityLabel(prop.priority, prop.priorityLabel)}</span></td>
          <td>${prop.milestone.current}/${prop.milestone.total} ${prop.milestone.label}</td>
          <td>${prop.areaGF} m²</td>
          <td>${formatPriceRange(prop.valueMin, prop.valueMax)}</td>
        </tr>`).join('');
    }

    // --- REPAIRED SIDEBAR RENDER FUNCTION ---
    function renderMapView() {
      const data = getDataToRender();
      document.getElementById('objectCount').textContent = data.length;
      const sidebar = document.getElementById('mapSidebar');
      
      // Neue Struktur: Bild-Container mit Tag (Overlay) -> Inhalt (Name + Preis)
      sidebar.innerHTML = data.map(prop => `
        <div class="map-sidebar-item" data-id="${prop.id}" onclick="flyToProperty('${prop.id}')">
          <div class="map-sidebar-image" style="background-image: url('${getPlaceholderImage(prop.type, prop.id)}')">
            <span class="priority-tag ${getPriorityClass(prop.priority)}">${getPriorityLabel(prop.priority, prop.priorityLabel)}</span>
          </div>
          <div class="map-sidebar-content">
            <div class="map-sidebar-title">${prop.type} in ${prop.zip} ${prop.city}</div>
            <div class="map-sidebar-price">${formatPriceRange(prop.valueMin, prop.valueMax)}</div>
          </div>
        </div>`).join('');

      if (!map) {
        initializeMap();
      } else if (mapLoaded) {
        updateMapMarkers(data);
      }
      // Wenn map existiert aber noch nicht geladen ist,
      // werden die Marker automatisch beim 'load'-Event aktualisiert
    }

    function flyToProperty(id) {
      const prop = properties.find(p => p.id === id);
      if (!prop || !prop.lat || !prop.lng) return;
      document.querySelectorAll('.map-sidebar-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.id === id) item.classList.add('active');
      });
      document.querySelectorAll('.marker').forEach(m => m.classList.remove('selected'));
      const md = markersMap.get(id);
      if (md) {
        md.marker.getElement().classList.add('selected');
        map.flyTo({ center: [prop.lng, prop.lat], zoom: 13, duration: 1500 });
        setTimeout(() => {
          const popup = md.marker.getPopup();
          if (popup && !popup.isOpen()) {
            md.marker.togglePopup();
          }
        }, 1600);
      }
    }

    function initializeMap() {
      map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v11',
        center: [8.2275, 46.8182], zoom: 7
      });
      map.addControl(new mapboxgl.NavigationControl(), 'top-right');
      map.on('load', () => {
        mapLoaded = true;
        updateMapMarkers(getDataToRender());
      });
    }

    function updateMapMarkers(data) {
      markers.forEach(marker => marker.remove());
      markers = []; markersMap.clear();
      const bounds = new mapboxgl.LngLatBounds();
      data.forEach(prop => {
        if (prop.lat && prop.lng) {
          const el = document.createElement('div');
          el.className = `marker marker-${prop.priority !== null ? prop.priority : 'null'}`;
          el.innerHTML = '<span class="material-icons">home</span>';
          el.addEventListener('click', () => {
            document.querySelectorAll('.marker').forEach(m => m.classList.remove('selected'));
            el.classList.add('selected');
            flyToProperty(prop.id);
          });

          const popup = new mapboxgl.Popup({ offset: 25, maxWidth: '280px' }).setHTML(`
            <div class="popup-image" style="background-image: url('${getPlaceholderImage(prop.type, prop.id)}')"></div>
            <div class="popup-content">
              <div class="popup-title">${prop.type}</div>
              <div class="popup-location">${prop.address}, ${prop.city}</div>
              <div class="popup-price">${formatPriceRange(prop.valueMin, prop.valueMax)}</div>
              <div class="popup-link" onclick="openModal('${prop.id}')">Details anzeigen</div>
            </div>`);

          const marker = new mapboxgl.Marker(el).setLngLat([prop.lng, prop.lat]).setPopup(popup).addTo(map);
          markers.push(marker);
          markersMap.set(prop.id, { marker, prop });
          bounds.extend([prop.lng, prop.lat]);
        }
      });
      if (markers.length > 0) map.fitBounds(bounds, { padding: 80, maxZoom: 10 });
    }

    function setView(view) {
      currentView = view;
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
        const label = btn.querySelector('.view-btn-label');
        if (label) label.remove();
      });
      const activeBtn = document.querySelector(`.view-btn[data-view="${view}"]`);
      if (activeBtn) {
        activeBtn.classList.add('active');
        const label = document.createElement('span');
        label.className = 'view-btn-label';
        label.textContent = { gallery: 'Galerie', list: 'Liste', map: 'Karte' }[view];
        activeBtn.appendChild(label);
      }

      document.getElementById('galleryView').classList.remove('active');
      document.getElementById('listView').classList.remove('active');
      document.getElementById('mapView').classList.remove('active');

      if (view === 'gallery') {
        document.getElementById('galleryView').classList.add('active');
        renderCards();
      } else if (view === 'list') {
        document.getElementById('listView').classList.add('active');
        renderListView();
      } else if (view === 'map') {
        document.getElementById('mapView').classList.add('active');
        renderMapView();
        setTimeout(() => { if (map) map.resize(); }, 150);
      }
      updateUrlParams();
    }

    function setupViewToggle() {
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const view = btn.dataset.view;
          if (view) setView(view);
        });
      });
    }

    function exportToExcel() { alert('Excel Export Placeholder'); }

    function setupFilterModal() {
      // Open filter modal
      document.getElementById('filterBtn').addEventListener('click', openFilterModal);

      // Close filter modal
      document.getElementById('filterCloseBtn').addEventListener('click', closeFilterModal);
      document.getElementById('filterModalOverlay').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeFilterModal();
      });

      // Reset filters button in modal
      document.getElementById('filterResetBtn').addEventListener('click', () => {
        resetAllFilters();
      });

      // Close on Escape key (handles both modals)
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (document.getElementById('filterModalOverlay').classList.contains('active')) {
            closeFilterModal();
          } else if (document.getElementById('modalOverlay').classList.contains('active')) {
            closeModal();
          }
        }
      });
    }

    function setupSearch() {
      const searchInput = document.getElementById('searchInput');
      let debounceTimer;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          searchQuery = e.target.value.trim();
          applyFilters();
        }, 300);
      });
    }

    function openModal(id) {
      const prop = properties.find(p => p.id === id);
      if (!prop) return;
      document.getElementById('modalBreadcrumb').textContent = `Verkaufsjahr ${prop.year} / ${prop.id}`;
      document.getElementById('modalBody').innerHTML = `
        <div class="detail-top">
          <div class="detail-image" style="background-image: url('${getPlaceholderImage(prop.type, prop.id)}')"></div>
          <div class="detail-summary">
            <h1 class="detail-title">${prop.type} <span>in ${prop.zip} ${prop.city}</span></h1>
            <p class="detail-address">${prop.address}</p>
            <div class="detail-status"><div class="detail-status-step">${prop.milestone.current}/${prop.milestone.total} ${prop.milestone.label}</div></div>
            <div class="detail-areas">
                <div class="detail-area"><span class="detail-area-icon">◫</span><span class="detail-area-value">${prop.areaGF} m²</span><span class="detail-area-label">GF</span></div>
                <div class="detail-area"><span class="detail-area-icon">⊞</span><span class="detail-area-value">${prop.areaGSF} m²</span><span class="detail-area-label">GSF</span></div>
            </div>
            <div class="detail-price">${formatPriceRange(prop.valueMin, prop.valueMax)}</div>
          </div>
        </div>
        <div class="detail-section">
          <h2 class="detail-section-title">Daten</h2>
          <div class="detail-grid">
            <div class="detail-item"><div class="detail-item-label">ID</div><div class="detail-item-value">${prop.id}</div></div>
            <div class="detail-item"><div class="detail-item-label">Kanton</div><div class="detail-item-value">${prop.canton}</div></div>
            <div class="detail-item"><div class="detail-item-label">Buchwert</div><div class="detail-item-value">${formatCHF(prop.bookValue)}</div></div>
          </div>
        </div>`;
      document.getElementById('modalOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
      document.body.style.overflow = '';
    }
    document.getElementById('modalOverlay').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });
    // Note: Escape key for detail modal is handled in setupFilterModal to avoid conflicts

    // --- INIT ---
    setupFilterModal();
    setupSearch();
    setupViewToggle();
    loadFiltersFromUrl();
    setView(currentView);

    fetch('data.json')
      .then(res => res.json())
      .then(data => {
        properties = data;
        filteredProperties = [...data];
        extractFilterOptions();
        applyFilters();
      })
      .catch(err => {
        console.error('Error loading data:', err);
        document.getElementById('objectGrid').innerHTML = `<div style="grid-column: 1/-1; padding: 20px; text-align: center; background: white;">Fehler beim Laden. Starte via Live Server.</div>`;
      });
  </script>
</body>
</html>
