<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verkaufsplattform - Bundesamt für Bauten und Logistik</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet" />
  <style>
    /* Reset & Base */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html { height: 100%; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.5;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    /* Header */
    .header {
      background-color: #383E54;
      color: white;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
      flex-shrink: 0;
    }

    .header-left { display: flex; align-items: center; gap: 16px; }

    .logo {
      width: 32px; height: 32px;
      background: white; color: #383E54;
      border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; font-weight: bold;
    }

    .header-title { display: flex; flex-direction: column; }
    .header-title-main { font-size: 14px; font-weight: 600; }
    .header-title-sub { font-size: 12px; opacity: 0.9; }
    .header-right { display: flex; gap: 16px; }

    .btn {
      padding: 8px 16px; border-radius: 4px;
      font-size: 14px; cursor: pointer; border: none;
      transition: background-color 0.2s;
    }
    .btn-primary { background-color: #097EAB; color: white; }
    .btn-primary:hover { background-color: #0a8fc2; }
    .btn-outline { background-color: transparent; color: white; border: 1px solid white; }
    .btn-outline:hover { background-color: rgba(255,255,255,0.1); }

    /* Main Content */
    .main {
      max-width: 1440px; margin: 0 auto; padding: 24px;
      flex: 1; display: flex; flex-direction: column; min-height: 0; width: 100%;
    }

    /* Search Section */
    .search-section { background: white; padding: 16px 0; flex-shrink: 0; }
    .search-section-inner { max-width: 1440px; margin: 0 auto; padding: 0 24px; }
    .search-row { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }

    .search-input-wrapper { flex: 1; position: relative; }
    .search-input-wrapper .material-icons-outlined {
      position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
      color: #888; font-size: 20px;
    }
    .search-input {
      width: 100%; padding: 12px 16px 12px 44px;
      border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .search-input:focus { outline: none; border-color: #00838f; box-shadow: 0 0 0 3px rgba(0,131,143,0.1); }

    .view-toggle { display: flex; background: #f5f5f5; border-radius: 6px; padding: 4px; }
    .view-btn {
      padding: 8px 12px; border: none; background: transparent; cursor: pointer;
      border-radius: 4px; color: #666; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .view-btn:hover { color: #333; }
    .view-btn.active { background: #383E54; color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .view-btn-label { font-size: 13px; font-weight: 500; margin-left: 6px; }

    /* Filter Pills */
    .filter-row { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
    .filter-pills { display: flex; flex-wrap: wrap; gap: 8px; }
    .filter-pill {
      padding: 8px 16px; border: 1px solid #e0e0e0; border-radius: 20px;
      font-size: 13px; background: white; color: #555; cursor: pointer;
      transition: all 0.2s; white-space: nowrap; display: inline-flex; align-items: center; gap: 6px;
    }
    .filter-pill:hover { border-color: #999; background: #f5f5f5; }
    .filter-pill.active { background: #e8e8e8; border-color: #ccc; color: #333; }
    .filter-pill .close-icon { display: none; font-size: 16px; margin-left: 2px; margin-right: -4px; }
    .filter-pill.active .close-icon { display: inline; }

    .reset-filters {
      display: none; align-items: center; justify-content: center; padding: 6px;
      border: none; background: transparent; color: #666; cursor: pointer;
      border-radius: 4px; transition: all 0.2s;
    }
    .reset-filters:hover { background: #f0f0f0; color: #333; }
    .reset-filters.visible { display: flex; }
    .filter-right { display: flex; align-items: center; gap: 16px; }
    .stats-count { font-size: 14px; color: #555; font-weight: 600; }
    .filter-btn {
      display: flex; align-items: center; gap: 6px; padding: 8px 16px;
      border: 1px solid #e0e0e0; border-radius: 20px; background: white;
      font-size: 13px; color: #555; cursor: pointer; transition: all 0.2s;
    }
    .filter-btn:hover { border-color: #00838f; color: #00838f; }

    /* Grid */
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; }
    @media (max-width: 1200px) { .grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 900px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }

    /* Card */
    .card {
      background: white; border-radius: 8px; overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08); cursor: pointer;
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.12); transform: translateY(-2px); }
    .card-image { position: relative; height: 180px; background-color: #e0e0e0; background-size: cover; background-position: center; }
    .card-badge { position: absolute; top: 12px; left: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .card-content { padding: 16px; }
    .card-label { font-size: 15px; font-weight: 600; color: #222; margin-bottom: 4px; }
    .card-location { font-size: 13px; color: #555; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #eee; }
    .card-price { font-size: 15px; font-weight: 600; color: #222; margin-bottom: 2px; }
    .card-price-sqm { font-size: 12px; color: #666; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #eee; }
    .card-details { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 8px; font-size: 13px; margin-bottom: 16px; }
    .card-detail-label { color: #555; font-weight: 500; }
    .card-detail-value { color: #222; text-align: right; font-weight: 500; }
    .card-milestone { padding-top: 12px; }
    .milestone-bar { height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden; margin-bottom: 8px; }
    .milestone-progress { height: 100%; background: linear-gradient(90deg, #00838f, #00acc1); border-radius: 3px; transition: width 0.3s; }
    .milestone-text { font-size: 13px; color: #555; font-weight: 500; }

    /* Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); display: flex; align-items: flex-start; justify-content: center;
      padding: 40px 20px; z-index: 1000; overflow-y: auto; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal {
      background: white; border-radius: 8px; width: 100%; max-width: 1000px;
      transform: translateY(20px); transition: transform 0.3s;
    }
    .modal-overlay.active .modal { transform: translateY(0); }
    .modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 24px; border-bottom: 1px solid #eee; background: #f9f9f9; border-radius: 8px 8px 0 0;
    }
    .modal-back {
      display: flex; align-items: center; gap: 8px; background: white; border: 1px solid #e0e0e0;
      padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; color: #333;
    }
    .modal-back:hover { background: #f5f5f5; }
    .modal-breadcrumb { font-size: 14px; color: #666; }
    .modal-body { padding: 24px; }

    /* Detail Styles */
    .detail-top { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px; }
    .detail-image { height: 300px; background: #e0e0e0; border-radius: 8px; background-size: cover; background-position: center; }
    .detail-summary { display: flex; flex-direction: column; gap: 16px; }
    .detail-title { font-size: 24px; font-weight: 600; color: #333; }
    .detail-title span { font-weight: 400; color: #666; }
    .detail-status { display: flex; align-items: center; gap: 16px; padding: 16px; background: #f5f5f5; border-radius: 8px; }
    .detail-areas { display: flex; gap: 24px; }
    .detail-area { display: flex; align-items: center; gap: 8px; }
    .tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 24px; }
    .tab { padding: 12px 20px; font-size: 14px; color: #666; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; }
    .tab.active { color: #00838f; border-bottom-color: #00838f; font-weight: 500; }
    .detail-section { margin-bottom: 32px; }
    .detail-section-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #333; }
    .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    .detail-item { padding: 12px 0; border-bottom: 1px solid #eee; }
    .market-value { background: #f9f9f9; padding: 20px; border-radius: 8px; }
    .market-value-display { font-size: 24px; font-weight: 600; color: #00838f; text-align: center; margin-bottom: 16px; }
    .market-value-bar { position: relative; height: 8px; background: linear-gradient(90deg, #e0e0e0, #00acc1, #00838f); border-radius: 4px; margin-bottom: 8px; }
    .market-value-marker { position: absolute; top: -4px; width: 16px; height: 16px; background: white; border: 3px solid #00838f; border-radius: 50%; transform: translateX(-50%); }
    .market-value-labels { display: flex; justify-content: space-between; font-size: 12px; color: #888; }

    /* Tags */
    .priority-tag { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 500; }
    .priority-0 { background-color: #ffebee; color: #c62828; }
    .priority-1 { background-color: #e8f5e9; color: #2e7d32; }
    .priority-2 { background-color: #e3f2fd; color: #1565c0; }
    .priority-3 { background-color: #f5f5f5; color: #616161; }
    .priority-null { background-color: #fafafa; color: #9e9e9e; border: 1px solid #e0e0e0; }

    /* Views */
    .view-container { display: none; }
    .view-container.active { display: block; }

    /* List View */
    .stats-boxes { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px; }
    .stats-box { background: white; border-radius: 8px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .stats-box-value { font-size: 32px; font-weight: 600; color: #333; margin-bottom: 4px; }
    .stats-box-label { font-size: 13px; color: #666; }
    .list-table-container { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .list-table { width: 100%; border-collapse: collapse; }
    .list-table th { background: #f9f9f9; padding: 14px 16px; text-align: left; font-size: 13px; font-weight: 600; color: #555; border-bottom: 1px solid #e0e0e0; }
    .list-table td { padding: 14px 16px; font-size: 14px; color: #333; border-bottom: 1px solid #e0e0e0; vertical-align: middle; }
    .list-table tbody tr:hover { background-color: #f5f5f5; cursor: pointer; }

    /* ========================================= */
    /* === MAP VIEW FIXED (CSS GRID LÖSUNG) === */
    /* ========================================= */
    .map-container {
        display: none;
        width: 100%;
        /* Höhe füllt den Bildschirm abzüglich Header/Search */
        height: calc(100vh - 180px);
        min-height: 500px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .map-container.active {
        /* GRID statt FLEX ist hier der Schlüssel! */
        display: grid;
        /* Spalte 1: 280px fix, Spalte 2: Rest */
        grid-template-columns: 280px 1fr;
    }

    .map-sidebar {
        /* Breite wird durch Grid-Zelle bestimmt */
        width: 100%;
        height: 100%; /* Füllt die Höhe der Zelle */
        background: white;
        overflow-y: auto;
        border-right: 1px solid #e0e0e0;
        scrollbar-width: thin;
    }

    .map-area {
        position: relative;
        /* Breite wird durch Grid-Zelle bestimmt */
        width: 100%;
        height: 100%;
        background-color: #e0e0e0; /* Debug-Grau */
        overflow: hidden;
    }

    #map {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        width: 100%;
        height: 100%;
    }

    /* Map Marker & Popup */
    .marker {
        width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3); border: 2px solid white;
    }
    .marker-0 { background-color: #e53935; }
    .marker-1 { background-color: #43a047; }
    .marker-2 { background-color: #1e88e5; }
    .marker-3 { background-color: #757575; }
    .marker-null { background-color: #9e9e9e; }
    .marker .material-icons { color: white; font-size: 16px; }
    .marker.selected { border: 3px solid #383E54; transform: scale(1.15); z-index: 10; }
    
    .mapboxgl-popup-content { padding: 0; border-radius: 8px; overflow: hidden; min-width: 250px; }
    .popup-image { height: 120px; background-size: cover; background-position: center; }
    .popup-content { padding: 12px; }
    .popup-link { display: block; text-align: center; padding: 8px 12px; background: #383E54; color: white; text-decoration: none; border-radius: 4px; margin-top: 8px; cursor: pointer; }

    /* Responsive Map */
    @media (max-width: 900px) {
        .stats-boxes { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 768px) {
        .detail-top { grid-template-columns: 1fr; }
        
        .map-container.active {
            /* Mobile: Zurück zu Flex für untereinander */
            display: flex; 
            flex-direction: column;
            height: auto;
        }
        .map-sidebar { width: 100%; max-height: 200px; border-right: none; border-bottom: 1px solid #e0e0e0; }
        .map-area { height: 400px; width: 100%; }
    }
    @media (max-width: 640px) {
        .header { padding: 12px 16px; height: auto; flex-wrap: wrap; gap: 12px; }
        .search-row, .filter-row { flex-direction: column; align-items: stretch; }
        .grid { grid-template-columns: 1fr; }
        .stats-boxes { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <div class="logo">C</div>
      <div class="header-title">
        <span class="header-title-main">Verkaufsplattform</span>
        <span class="header-title-sub">Bundesamt für Bauten und Logistik</span>
      </div>
    </div>
    <div class="header-right">
      <button class="btn btn-primary">Auftrag erstellen</button>
      <button class="btn btn-outline">Login</button>
    </div>
  </header>

  <div class="search-section">
    <div class="search-section-inner">
      <div class="search-row">
        <div class="search-input-wrapper">
          <span class="material-icons-outlined">search</span>
          <input type="text" class="search-input" id="searchInput" placeholder="Suche nach Bezeichnung, Adresse, oder Wirtschaftseinheit">
        </div>
        <div class="view-toggle">
          <button class="view-btn" data-view="map" title="Karte"><span class="material-icons-outlined">map</span></button>
          <button class="view-btn" data-view="list" title="Liste"><span class="material-icons-outlined">reorder</span><span class="view-btn-label">Liste</span></button>
          <button class="view-btn active" data-view="gallery" title="Galerie"><span class="material-icons-outlined">grid_view</span></button>
        </div>
      </div>
      <div class="filter-row">
        <div class="filter-pills">
          <button class="filter-pill" data-priority="0">Hohe Priorität (<span id="countPriority0">0</span>)<span class="material-icons-outlined close-icon">close</span></button>
          <button class="filter-pill" data-priority="1">Normale Priorität (<span id="countPriority1">0</span>)<span class="material-icons-outlined close-icon">close</span></button>
          <button class="filter-pill" data-priority="2">Geringe Priorität (<span id="countPriority2">0</span>)<span class="material-icons-outlined close-icon">close</span></button>
          <button class="filter-pill" data-priority="3">Keine Priorität (<span id="countPriority3">0</span>)<span class="material-icons-outlined close-icon">close</span></button>
          <button class="filter-pill" data-priority="null">Keine Angabe<span class="material-icons-outlined close-icon">close</span></button>
          <button class="reset-filters" id="resetFilters" title="Alle Filter zurücksetzen"><span class="material-icons-outlined">replay</span></button>
        </div>
        <div class="filter-right">
          <div class="stats-count"><span id="objectCount">0</span> Objekte</div>
          <button class="filter-btn"><span>Filter</span><span class="material-icons-outlined">tune</span></button>
        </div>
      </div>
    </div>
  </div>

  <main class="main">
    <div class="view-container active" id="galleryView">
      <div class="grid" id="objectGrid"></div>
    </div>

    <div class="view-container" id="listView">
      <div class="stats-boxes" id="statsBoxes">
        <div class="stats-box"><div class="stats-box-value" id="statsTotalObjects">0</div><div class="stats-box-label">Anzahl Objekte</div></div>
        <div class="stats-box"><div class="stats-box-value" id="statsHighPriority">0</div><div class="stats-box-label">Hohe Priorität (0)</div></div>
        <div class="stats-box"><div class="stats-box-value" id="statsNormalPriority">0</div><div class="stats-box-label">Normale Priorität (1)</div></div>
        <div class="stats-box"><div class="stats-box-value" id="statsLowPriority">0</div><div class="stats-box-label">Geringe Priorität (2)</div></div>
        <div class="stats-box stats-box-download" onclick="exportToExcel()"><span class="material-icons-outlined">download</span><div class="stats-box-label">Excel Download</div></div>
      </div>
      <div class="list-table-container">
        <table class="list-table">
          <thead><tr><th></th><th>ID</th><th>Objekt</th><th>Verkaufsjahr</th><th>Priorisierung</th><th>Meilenstein</th><th>Objekt Fläche</th><th>Marktwert</th></tr></thead>
          <tbody id="listTableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="map-container" id="mapView">
      <div class="map-sidebar" id="mapSidebar"></div>
      <div class="map-area">
        <div id="map"></div>
      </div>
    </div>
  </main>

  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <button class="modal-back" onclick="closeModal()">← Zurück zur Übersicht</button>
        <span class="modal-breadcrumb" id="modalBreadcrumb"></span>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiZGF2aWRyYXNuZXI1IiwiYSI6ImNtMm5yamVkdjA5MDcycXMyZ2I2MHRhamgifQ.m651j7WIX7MyxNh8KIQ1Gg';

    let properties = [];
    let filteredProperties = [];
    let activeFilters = new Set();
    let searchQuery = '';
    let currentView = 'gallery';
    let map = null;
    let markers = [];
    let markersMap = new Map();

    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return { priority: params.get('priority'), search: params.get('q'), view: params.get('view') };
    }

    function updateUrlParams() {
      const params = new URLSearchParams();
      if (currentView !== 'gallery') params.set('view', currentView);
      if (activeFilters.size > 0) params.set('priority', Array.from(activeFilters).join(','));
      if (searchQuery) params.set('q', searchQuery);
      const newUrl = params.toString() ? `${window.location.pathname}?${params.toString()}` : window.location.pathname;
      window.history.replaceState({}, '', newUrl);
    }

    function loadFiltersFromUrl() {
      const params = getUrlParams();
      if (params.view && ['gallery', 'list', 'map'].includes(params.view)) currentView = params.view;
      if (params.priority) {
        params.priority.split(',').forEach(p => {
          activeFilters.add(p);
          const pill = document.querySelector(`.filter-pill[data-priority="${p}"]`);
          if (pill) pill.classList.add('active');
        });
      }
      if (params.search) {
        searchQuery = params.search;
        document.getElementById('searchInput').value = searchQuery;
      }
    }

    function getPriorityClass(priority) { return (priority === null || priority === undefined) ? 'priority-null' : `priority-${priority}`; }
    function getPriorityLabel(priority, priorityLabel) { return (priority === null || priority === undefined) ? 'Keine Angabe' : `${priorityLabel} (${priority})`; }
    function formatCHF(value) { return (!value) ? 'CHF 0' : 'CHF ' + value.toLocaleString('de-CH').replace(/,/g, "'"); }
    function formatPriceRange(min, max) { return ((!min) && (!max)) ? 'CHF 0 - CHF 0' : formatCHF(min) + ' - ' + formatCHF(max); }
    function pricePerSqm(price, area) { return (!price || !area) ? 0 : Math.round(price / area); }

    function getPlaceholderImage(type, id) {
      const hash = id.split('').reduce((a, b) => { a = ((a << 5) - a) + b.charCodeAt(0); return a & a; }, 0);
      const imageIndex = Math.abs(hash) % 5;
      // Kurze Liste für Stabilität
      const images = ['https://images.unsplash.com/photo-1568605114967-8130f3a36994', 'https://images.unsplash.com/photo-1570129477492-45c003edd2be', 'https://images.unsplash.com/photo-1564013799919-ab600027ffc6', 'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab', 'https://images.unsplash.com/photo-1581094794329-c8112a89af12'];
      return images[imageIndex] + '?w=400&h=300&fit=crop';
    }

    function updatePriorityCounts() {
      const counts = { 0: 0, 1: 0, 2: 0, 3: 0 };
      properties.forEach(prop => { if (counts.hasOwnProperty(prop.priority)) counts[prop.priority]++; });
      for (let i = 0; i <= 3; i++) {
        const el = document.getElementById(`countPriority${i}`);
        if (el) el.textContent = counts[i];
      }
    }

    function updateResetButtonVisibility() {
      const resetBtn = document.getElementById('resetFilters');
      (activeFilters.size > 0 || searchQuery) ? resetBtn.classList.add('visible') : resetBtn.classList.remove('visible');
    }

    function resetAllFilters() {
      activeFilters.clear(); searchQuery = '';
      document.getElementById('searchInput').value = '';
      document.querySelectorAll('.filter-pill').forEach(pill => pill.classList.remove('active'));
      applyFilters();
    }

    function applyFilters() {
      filteredProperties = properties.filter(prop => {
        if (searchQuery) {
          const query = searchQuery.toLowerCase();
          const searchFields = [prop.id, prop.title, prop.type, prop.city, prop.zip, prop.address, prop.canton].map(f => (f || '').toLowerCase());
          if (!searchFields.some(field => field.includes(query))) return false;
        }
        if (activeFilters.size > 0) return activeFilters.has(String(prop.priority));
        return true;
      });

      if (currentView === 'gallery') renderCards();
      else if (currentView === 'list') renderListView();
      else if (currentView === 'map') renderMapView();

      updateUrlParams();
      updateResetButtonVisibility();
    }

    function getDataToRender() { return (filteredProperties.length > 0 || activeFilters.size > 0 || searchQuery) ? filteredProperties : properties; }

    function renderCards() {
      const grid = document.getElementById('objectGrid');
      const data = getDataToRender();
      document.getElementById('objectCount').textContent = data.length;
      grid.innerHTML = data.map(prop => `
        <div class="card" onclick="openModal('${prop.id}')">
          <div class="card-image" style="background-image: url('${getPlaceholderImage(prop.type, prop.id)}')">
            <span class="card-badge priority-tag ${getPriorityClass(prop.priority)}">${getPriorityLabel(prop.priority, prop.priorityLabel)}</span>
          </div>
          <div class="card-content">
            <div class="card-label">${prop.id} ${prop.type}</div>
            <div class="card-location">In ${prop.zip} ${prop.city}</div>
            <div class="card-price">${formatPriceRange(prop.valueMin, prop.valueMax)}</div>
            <div class="card-details">
              <span class="card-detail-label">Jahr:</span><span class="card-detail-value">${prop.year}</span>
              <span class="card-detail-label">Fläche:</span><span class="card-detail-value">${prop.areaGF} m²</span>
            </div>
          </div>
        </div>`).join('');
    }

    function renderListView() {
      const data = getDataToRender();
      document.getElementById('objectCount').textContent = data.length;
      const stats = { total: data.length, 0: 0, 1: 0, 2: 0 };
      data.forEach(p => { if (stats.hasOwnProperty(p.priority)) stats[p.priority]++; });
      document.getElementById('statsTotalObjects').textContent = stats.total;
      document.getElementById('statsHighPriority').textContent = stats[0];
      document.getElementById('statsNormalPriority').textContent = stats[1];
      document.getElementById('statsLowPriority').textContent = stats[2];

      const tbody = document.getElementById('listTableBody');
      tbody.innerHTML = data.map(prop => `
        <tr onclick="openModal('${prop.id}')">
          <td><span class="material-icons-outlined object-icon">home</span></td>
          <td>${prop.id}</td>
          <td>${prop.type} in ${prop.zip} ${prop.city}</td>
          <td>${prop.year}</td>
          <td><span class="priority-tag ${getPriorityClass(prop.priority)}">${getPriorityLabel(prop.priority, prop.priorityLabel)}</span></td>
          <td>${prop.milestone.current}/${prop.milestone.total} ${prop.milestone.label}</td>
          <td>${prop.areaGF} m²</td>
          <td>${formatPriceRange(prop.valueMin, prop.valueMax)}</td>
        </tr>`).join('');
    }

    function renderMapView() {
      const data = getDataToRender();
      document.getElementById('objectCount').textContent = data.length;
      const sidebar = document.getElementById('mapSidebar');
      sidebar.innerHTML = data.map(prop => `
        <div class="map-sidebar-item" data-id="${prop.id}" onclick="flyToProperty('${prop.id}')">
          <div class="map-sidebar-title">${prop.type} in ${prop.city}</div>
          <div class="map-sidebar-image" style="background-image: url('${getPlaceholderImage(prop.type, prop.id)}')">
            <span class="priority-tag ${getPriorityClass(prop.priority)}">${prop.priorityLabel}</span>
          </div>
          <div class="map-sidebar-price">${formatCHF(prop.valueMin)}</div>
        </div>`).join('');

      if (!map) initializeMap(data);
      else updateMapMarkers(data);
    }

    function flyToProperty(id) {
      const prop = properties.find(p => p.id === id);
      if (!prop || !prop.lat || !prop.lng) return;
      document.querySelectorAll('.map-sidebar-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.id === id) item.classList.add('active');
      });
      document.querySelectorAll('.marker').forEach(m => m.classList.remove('selected'));
      const md = markersMap.get(id);
      if (md) {
        md.marker.getElement().classList.add('selected');
        map.flyTo({ center: [prop.lng, prop.lat], zoom: 13, duration: 1500 });
        setTimeout(() => { md.marker.togglePopup(); }, 1600);
      }
    }

    function initializeMap(data) {
      map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v11',
        center: [8.2275, 46.8182], zoom: 7
      });
      map.addControl(new mapboxgl.NavigationControl(), 'top-right');
      map.on('load', () => updateMapMarkers(data));
    }

    function updateMapMarkers(data) {
      markers.forEach(marker => marker.remove());
      markers = []; markersMap.clear();
      const bounds = new mapboxgl.LngLatBounds();
      data.forEach(prop => {
        if (prop.lat && prop.lng) {
          const el = document.createElement('div');
          el.className = `marker marker-${prop.priority !== null ? prop.priority : 'null'}`;
          el.innerHTML = '<span class="material-icons">home</span>';
          el.addEventListener('click', () => {
            document.querySelectorAll('.marker').forEach(m => m.classList.remove('selected'));
            el.classList.add('selected');
            flyToProperty(prop.id); // Sync with sidebar
          });

          const popup = new mapboxgl.Popup({ offset: 25, maxWidth: '280px' }).setHTML(`
            <div class="popup-image" style="background-image: url('${getPlaceholderImage(prop.type, prop.id)}')"></div>
            <div class="popup-content">
              <div class="popup-title">${prop.type}</div>
              <div class="popup-location">${prop.address}, ${prop.city}</div>
              <div class="popup-price">${formatPriceRange(prop.valueMin, prop.valueMax)}</div>
              <div class="popup-link" onclick="openModal('${prop.id}')">Details anzeigen</div>
            </div>`);

          const marker = new mapboxgl.Marker(el).setLngLat([prop.lng, prop.lat]).setPopup(popup).addTo(map);
          markers.push(marker);
          markersMap.set(prop.id, { marker, prop });
          bounds.extend([prop.lng, prop.lat]);
        }
      });
      if (markers.length > 0) map.fitBounds(bounds, { padding: 80, maxZoom: 10 });
    }

    function setView(view) {
      currentView = view;
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
        const label = btn.querySelector('.view-btn-label');
        if (label) label.remove();
      });
      const activeBtn = document.querySelector(`.view-btn[data-view="${view}"]`);
      if (activeBtn) {
        activeBtn.classList.add('active');
        const label = document.createElement('span');
        label.className = 'view-btn-label';
        label.textContent = { gallery: 'Galerie', list: 'Liste', map: 'Karte' }[view];
        activeBtn.appendChild(label);
      }

      document.getElementById('galleryView').classList.remove('active');
      document.getElementById('listView').classList.remove('active');
      document.getElementById('mapView').classList.remove('active');

      if (view === 'gallery') {
        document.getElementById('galleryView').classList.add('active');
        renderCards();
      } else if (view === 'list') {
        document.getElementById('listView').classList.add('active');
        renderListView();
      } else if (view === 'map') {
        document.getElementById('mapView').classList.add('active');
        renderMapView();
        setTimeout(() => { if (map) map.resize(); }, 150);
      }
      updateUrlParams();
    }

    function setupViewToggle() {
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const view = btn.dataset.view;
          if (view) setView(view);
        });
      });
    }

    function exportToExcel() { alert('Excel Export Placeholder'); }

    function setupFilterPills() {
      document.querySelectorAll('.filter-pill').forEach(pill => {
        pill.addEventListener('click', () => {
          const priority = pill.dataset.priority;
          if (activeFilters.has(priority)) {
            activeFilters.delete(priority);
            pill.classList.remove('active');
          } else {
            activeFilters.add(priority);
            pill.classList.add('active');
          }
          applyFilters();
        });
      });
      document.getElementById('resetFilters').addEventListener('click', resetAllFilters);
    }

    function setupSearch() {
      const searchInput = document.getElementById('searchInput');
      let debounceTimer;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          searchQuery = e.target.value.trim();
          applyFilters();
        }, 300);
      });
    }

    function openModal(id) {
      const prop = properties.find(p => p.id === id);
      if (!prop) return;
      document.getElementById('modalBreadcrumb').textContent = `Verkaufsjahr ${prop.year} / ${prop.id}`;
      document.getElementById('modalBody').innerHTML = `
        <div class="detail-top">
          <div class="detail-image" style="background-image: url('${getPlaceholderImage(prop.type, prop.id)}')"></div>
          <div class="detail-summary">
            <h1 class="detail-title">${prop.type} <span>in ${prop.zip} ${prop.city}</span></h1>
            <p class="detail-address">${prop.address}</p>
            <div class="detail-status"><div class="detail-status-step">${prop.milestone.current}/${prop.milestone.total} ${prop.milestone.label}</div></div>
            <div class="detail-price">${formatPriceRange(prop.valueMin, prop.valueMax)}</div>
          </div>
        </div>
        <div class="detail-section">
          <div class="detail-grid">
            <div class="detail-item"><div class="detail-item-label">ID</div><div class="detail-item-value">${prop.id}</div></div>
            <div class="detail-item"><div class="detail-item-label">Kanton</div><div class="detail-item-value">${prop.canton}</div></div>
            <div class="detail-item"><div class="detail-item-label">Fläche</div><div class="detail-item-value">${prop.areaGF} m²</div></div>
          </div>
        </div>`;
      document.getElementById('modalOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
      document.body.style.overflow = '';
    }
    document.getElementById('modalOverlay').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

    // --- INITIALISIERUNG ---
    
    // 1. Erst UI Setup (damit Buttons auch ohne Daten gehen)
    setupFilterPills();
    setupSearch();
    setupViewToggle();
    loadFiltersFromUrl();
    setView(currentView);

    // 2. Dann Daten laden
    fetch('data.json')
      .then(res => res.json())
      .then(data => {
        properties = data;
        filteredProperties = [...data];
        updatePriorityCounts();
        applyFilters();
      })
      .catch(err => {
        console.error('Error loading data:', err);
        document.getElementById('objectGrid').innerHTML = `<div style="grid-column: 1/-1; padding: 20px; text-align: center; background: white;">Fehler beim Laden. Starte via Live Server.</div>`;
      });
  </script>
</body>
</html>
